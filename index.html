<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>AlQuranDeep - Understand the Quran Deeply</title>
    <style>
        :root {
            --primary-color: #1a3c34;
            --secondary-color: #ffd700;
            --text-color: #333;
            --background-color: #f5f5f5;
            --table-border: #ddd;
            --table-header: #f2f2f2;
        }

        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            margin: 0;
            padding: 0;
            background-color: var(--background-color);
            color: var(--text-color);
            transition: background-color 0.3s, color 0.3s;
        }

        .container {
            display: flex;
            flex-direction: column;
            min-height: 100vh;
        }

        header {
            background-color: var(--primary-color);
            color: white;
            text-align: center;
            padding: 15px 10px;
            position: sticky;
            top: 0;
            z-index: 100;
            box-shadow: 0 2px 5px rgba(0, 0, 0, 0.1);
        }

        .header-controls {
            position: absolute;
            top: 50%;
            transform: translateY(-50%);
            right: 15px;
            display: flex;
            gap: 8px;
        }

        .header-controls.left {
            left: 15px;
            right: auto;
        }

        .header-controls button {
            background: rgba(255, 255, 255, 0.2);
            border: none;
            color: white;
            padding: 8px 12px;
            border-radius: 5px;
            cursor: pointer;
            font-size: 14px;
            transition: background-color 0.3s;
        }

        .header-controls button:hover {
            background: rgba(255, 255, 255, 0.3);
        }

        #autoplay-btn {
            position: relative;
        }

        #autoplay-btn:active {
            transform: scale(0.95);
        }

        .bismillah {
            font-size: 2.2em;
            color: var(--secondary-color);
            text-shadow: 2px 2px 4px rgba(0, 0, 0, 0.5);
            margin-bottom: 5px;
        }

        .surah-info {
            font-size: 1.3em;
            margin-top: 5px;
            opacity: 0.9;
        }

        main {
            flex: 1;
            padding: 20px;
            text-align: center;
            padding-bottom: 120px;
            max-width: 1200px;
            margin: 0 auto;
        }

        #arabic {
            cursor: pointer;
            font-size: 1.8em;
            margin: 20px 0;
            transition: font-size 0.3s, color 0.3s;
            font-family: 'Traditional Arabic', 'Scheherazade', 'Amiri', serif;
            line-height: 1.6;
            color: var(--primary-color);
            user-select: text;
        }

        #arabic:hover {
            color: var(--secondary-color);
        }

        .pronunciation {
            margin: 15px 0;
            font-size: 1.3em;
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 15px;
            flex-wrap: wrap;
        }

        .audio-controls {
            display: flex;
            align-items: center;
            gap: 10px;
        }

        .play-btn {
            background: linear-gradient(135deg, var(--primary-color), #2a5d52);
            color: white;
            border: none;
            padding: 10px 15px;
            border-radius: 25px;
            cursor: pointer;
            font-size: 16px;
            display: flex;
            align-items: center;
            gap: 8px;
            transition: all 0.3s ease;
            box-shadow: 0 2px 10px rgba(0, 0, 0, 0.1);
        }

        .play-btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 4px 15px rgba(0, 0, 0, 0.2);
        }

        .word-table {
            margin: 30px auto;
            border-collapse: collapse;
            width: 95%;
            box-shadow: 0 4px 15px rgba(0, 0, 0, 0.1);
            border-radius: 10px;
            overflow: hidden;
            background: white;
        }

        .word-table th,
        .word-table td {
            border: 1px solid var(--table-border);
            padding: 12px 15px;
        }

        .word-table th {
            background: linear-gradient(135deg, var(--table-header), #e8e8e8);
            font-weight: 600;
            text-transform: uppercase;
            letter-spacing: 0.5px;
            font-size: 14px;
        }

        .arabic-word {
            font-size: 1.4em;
            font-family: 'Traditional Arabic', 'Scheherazade', 'Amiri', serif;
            text-align: right;
            color: var(--primary-color);
            font-weight: 500;
        }

        .word-table td {
            vertical-align: middle;
            transition: background-color 0.2s;
        }

        .word-table tr:hover {
            background-color: #f8f9fa;
        }

        .tafsir {
            margin: 30px 0;
            text-align: left;
            border-top: 2px solid var(--primary-color);
            padding-top: 20px;
        }

        .tafsir-controls {
            display: flex;
            align-items: center;
            gap: 15px;
            margin-bottom: 15px;
            flex-wrap: wrap;
        }

        .tafsir-row {
            display: flex;
            align-items: center;
            gap: 10px;
            width: 100%;
            flex-wrap: nowrap;
        }

        .tafsir-label {
            font-weight: bold;
            white-space: nowrap;
            min-width: fit-content;
        }

        .language-select {
            padding: 8px 12px;
            font-size: 14px;
            border: 2px solid var(--table-border);
            border-radius: 5px;
            background: white;
            cursor: pointer;
            transition: border-color 0.3s;
            min-width: 100px;
            max-width: 120px;
        }

        .tafsir-select {
            padding: 8px 12px;
            font-size: 14px;
            border: 2px solid var(--table-border);
            border-radius: 5px;
            background: white;
            cursor: pointer;
            transition: border-color 0.3s;
            flex: 1;
            min-width: 180px;
        }

        .tafsir-toggle {
            padding: 8px 16px;
            font-size: 14px;
            white-space: nowrap;
            min-width: fit-content;
        }

        .tafsir-selector {
            display: flex;
            align-items: center;
            gap: 10px;
        }

        .tafsir-selector select {
            padding: 8px 12px;
            font-size: 14px;
            border: 2px solid var(--table-border);
            border-radius: 5px;
            background: white;
            cursor: pointer;
            transition: border-color 0.3s;
        }

        .tafsir-selector select:focus {
            border-color: var(--primary-color);
            outline: none;
        }

        .tafsir-content {
            background: linear-gradient(135deg, #f9f9f9, #ffffff);
            padding: 20px;
            border-radius: 10px;
            margin-top: 15px;
            line-height: 1.8;
            border-left: 4px solid var(--secondary-color);
            box-shadow: 0 2px 10px rgba(0, 0, 0, 0.05);
        }

        .tafsir-header {
            margin-bottom: 15px;
            padding-bottom: 10px;
            border-bottom: 2px solid #e0e0e0;
        }

        .tafsir-header strong {
            color: var(--primary-color);
            font-size: 1.1em;
        }

        .tafsir-header em {
            color: #666;
            font-size: 0.9em;
        }

        .tafsir-body {
            text-align: justify;
        }

        .tafsir-body p {
            margin-bottom: 12px;
        }

        .tafsir-body strong {
            color: var(--primary-color);
        }

        .search-container {
            position: relative;
            display: inline-block;
            width: 220px;
        }

        #search {
            width: 100%;
            padding: 8px 15px;
            font-size: 14px;
            border: 2px solid #ddd;
            border-radius: 25px;
            box-sizing: border-box;
            transition: all 0.3s ease;
        }

        #search:focus {
            border-color: var(--primary-color);
            outline: none;
            box-shadow: 0 0 0 3px rgba(26, 60, 52, 0.1);
        }

        footer.nav-bar {
            position: fixed;
            bottom: 0;
            width: 100%;
            background: linear-gradient(135deg, var(--primary-color), #2a5d52);
            padding: 15px 10px;
            text-align: center;
            z-index: 100;
            box-shadow: 0 -2px 10px rgba(0, 0, 0, 0.1);
        }

        .nav-controls {
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 10px;
            flex-wrap: wrap;
        }

        footer.nav-bar button {
            background: rgba(255, 255, 255, 0.15);
            border: none;
            color: white;
            padding: 10px 15px;
            border-radius: 5px;
            cursor: pointer;
            font-size: 16px;
            font-weight: 500;
            transition: all 0.3s ease;
        }

        footer.nav-bar button:hover {
            background: rgba(255, 255, 255, 0.25);
            transform: translateY(-1px);
        }

        .loading {
            display: none;
            margin: 30px auto;
            text-align: center;
            font-style: italic;
            color: #666;
            font-size: 18px;
        }

        .loading::after {
            content: '...';
            animation: dots 1.5s steps(5, end) infinite;
        }

        @keyframes dots {

            0%,
            20% {
                color: transparent;
                text-shadow: .25em 0 0 transparent, .5em 0 0 transparent;
            }

            40% {
                color: #666;
                text-shadow: .25em 0 0 transparent, .5em 0 0 transparent;
            }

            60% {
                text-shadow: .25em 0 0 #666, .5em 0 0 transparent;
            }

            80%,
            100% {
                text-shadow: .25em 0 0 #666, .5em 0 0 #666;
            }
        }

        /* Settings Panel */
        .settings-panel {
            display: none;
            position: fixed;
            top: 80px;
            right: 15px;
            background: white;
            border: none;
            border-radius: 10px;
            padding: 20px;
            box-shadow: 0 10px 30px rgba(0, 0, 0, 0.2);
            z-index: 999;
            min-width: 250px;
        }

        .settings-panel h3 {
            margin-top: 0;
            color: var(--primary-color);
            border-bottom: 2px solid var(--secondary-color);
            padding-bottom: 10px;
        }

        .settings-panel label {
            display: flex;
            align-items: center;
            justify-content: space-between;
            margin: 15px 0;
            cursor: pointer;
            font-weight: 500;
        }

        .toggle-switch {
            position: relative;
            width: 50px;
            height: 24px;
            background: #ccc;
            border-radius: 12px;
            transition: background 0.3s;
        }

        .toggle-switch.active {
            background: var(--primary-color);
        }

        .toggle-switch::after {
            content: '';
            position: absolute;
            top: 2px;
            left: 2px;
            width: 20px;
            height: 20px;
            background: white;
            border-radius: 10px;
            transition: transform 0.3s;
        }

        .toggle-switch.active::after {
            transform: translateX(26px);
        }

        /* Bookmarks Panel */
        .bookmarks-panel {
            display: none;
            position: fixed;
            top: 80px;
            left: 15px;
            background: white;
            border: none;
            border-radius: 10px;
            padding: 20px;
            box-shadow: 0 10px 30px rgba(0, 0, 0, 0.2);
            z-index: 999;
            max-height: 70vh;
            overflow-y: auto;
            min-width: 280px;
        }

        .bookmarks-panel h3 {
            margin-top: 0;
            color: var(--primary-color);
            border-bottom: 2px solid var(--secondary-color);
            padding-bottom: 10px;
        }

        .bookmark-item {
            padding: 12px;
            border-bottom: 1px solid #eee;
            cursor: pointer;
            border-radius: 5px;
            margin-bottom: 5px;
            transition: all 0.2s;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .bookmark-item:hover {
            background: #f8f9fa;
            transform: translateX(5px);
        }

        .bookmark-delete {
            background: #ff4757;
            color: white;
            border: none;
            border-radius: 3px;
            padding: 4px 8px;
            cursor: pointer;
            font-size: 12px;
        }

        .error-message {
            background: linear-gradient(135deg, #ffebee, #ffcdd2);
            color: #c62828;
            padding: 15px;
            margin: 15px 0;
            border-radius: 8px;
            border-left: 4px solid #f44336;
            text-align: left;
        }

        /* Enhanced Notification System */
        .notification {
            position: fixed;
            top: 20px;
            right: 20px;
            min-width: 300px;
            max-width: 400px;
            padding: 16px 20px;
            border-radius: 12px;
            box-shadow: 0 8px 32px rgba(0, 0, 0, 0.1);
            backdrop-filter: blur(10px);
            z-index: 1000;
            display: flex;
            align-items: center;
            gap: 12px;
            font-size: 14px;
            line-height: 1.4;
            border: 1px solid rgba(255, 255, 255, 0.2);
            opacity: 0;
            transform: translateX(100%);
        }

        .notification-info {
            background: linear-gradient(135deg, #e3f2fd, #bbdefb);
            color: #1565c0;
            border-left: 4px solid #2196f3;
        }

        .notification-success {
            background: linear-gradient(135deg, #e8f5e8, #c8e6c9);
            color: #2e7d32;
            border-left: 4px solid #4caf50;
        }

        .notification-warning {
            background: linear-gradient(135deg, #fff3e0, #ffcc02);
            color: #ef6c00;
            border-left: 4px solid #ff9800;
        }

        .notification-error {
            background: linear-gradient(135deg, #ffebee, #ffcdd2);
            color: #c62828;
            border-left: 4px solid #f44336;
        }

        .notification-icon {
            font-size: 18px;
            flex-shrink: 0;
        }

        .notification-message {
            flex: 1;
            font-weight: 500;
        }

        .notification-close {
            background: none;
            border: none;
            font-size: 18px;
            cursor: pointer;
            padding: 0;
            width: 24px;
            height: 24px;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            opacity: 0.7;
            transition: opacity 0.2s, background-color 0.2s;
            flex-shrink: 0;
        }

        .notification-close:hover {
            opacity: 1;
            background-color: rgba(0, 0, 0, 0.1);
        }

        /* Loading Spinner */
        .loading-spinner {
            display: inline-block;
            width: 14px;
            height: 14px;
            border: 2px solid rgba(255, 255, 255, 0.3);
            border-radius: 50%;
            border-top-color: currentColor;
            animation: spin 1s ease-in-out infinite;
        }

        /* Smooth Transitions for Interactive Elements */
        button,
        .play-btn,
        .nav-btn {
            transition: all 0.2s ease;
        }

        button:hover,
        .play-btn:hover,
        .nav-btn:hover {
            transform: translateY(-1px);
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.15);
        }

        button:active,
        .play-btn:active,
        .nav-btn:active {
            transform: translateY(0);
            box-shadow: 0 2px 6px rgba(0, 0, 0, 0.1);
        }

        /* Animation Keyframes */
        @keyframes slideIn {
            from {
                opacity: 0;
                transform: translateX(100%);
            }

            to {
                opacity: 1;
                transform: translateX(0);
            }
        }

        @keyframes slideOut {
            from {
                opacity: 1;
                transform: translateX(0);
            }

            to {
                opacity: 0;
                transform: translateX(100%);
            }
        }

        @keyframes spin {
            to {
                transform: rotate(360deg);
            }
        }

        @keyframes fadeIn {
            from {
                opacity: 0;
            }

            to {
                opacity: 1;
            }
        }

        @keyframes pulse {

            0%,
            100% {
                transform: scale(1);
            }

            50% {
                transform: scale(1.05);
            }
        }

        /* Night Mode for Notifications */
        body.night-mode .notification-info {
            background: linear-gradient(135deg, #1a237e, #3f51b5);
            color: #e3f2fd;
        }

        body.night-mode .notification-success {
            background: linear-gradient(135deg, #1b5e20, #4caf50);
            color: #e8f5e8;
        }

        body.night-mode .notification-warning {
            background: linear-gradient(135deg, #e65100, #ff9800);
            color: #fff3e0;
        }

        body.night-mode .notification-error {
            background: linear-gradient(135deg, #b71c1c, #f44336);
            color: #ffebee;
        }

        /* Night Mode */
        body.night-mode {
            --background-color: #121212;
            --text-color: #e0e0e0;
            --table-border: #333;
            --table-header: #2a2a2a;
            --primary-color: #2d5a4f;
        }

        body.night-mode .settings-panel,
        body.night-mode .bookmarks-panel {
            background: #1e1e1e;
            color: #e0e0e0;
        }

        body.night-mode .word-table {
            background: #1e1e1e;
        }

        body.night-mode .bookmark-item:hover {
            background: #2a2a2a;
        }

        body.night-mode .tafsir-content {
            background: linear-gradient(135deg, #1e1e1e, #2a2a2a);
        }

        body.night-mode .tafsir-header {
            border-bottom-color: #444;
        }

        body.night-mode .tafsir-header strong {
            color: #5fb3a3;
        }

        body.night-mode .tafsir-header em {
            color: #aaa;
        }

        body.night-mode .tafsir-body strong {
            color: #5fb3a3;
        }

        body.night-mode #search {
            background: #2a2a2a;
            color: #e0e0e0;
            border-color: #444;
        }

        /* Responsive Design */
        @media (max-width: 768px) {
            .header-controls {
                position: absolute;
                top: 50%;
                transform: translateY(-50%);
                gap: 6px;
            }

            .header-controls button {
                padding: 6px 8px;
                font-size: 12px;
                min-width: 32px;
            }

            .bismillah {
                font-size: 1.8em;
            }

            .surah-info {
                font-size: 1.1em;
            }

            main {
                padding: 15px 10px 120px;
            }

            #arabic {
                font-size: 1.5em;
            }

            .word-table {
                width: 100%;
                font-size: 0.9em;
            }

            .pronunciation {
                flex-direction: column;
                gap: 10px;
            }

            .nav-controls {
                gap: 5px;
                padding: 10px;
            }

            .nav-controls button {
                padding: 8px 12px;
                font-size: 14px;
                min-width: 36px;
            }

            .search-container {
                width: 160px;
            }

            #search {
                font-size: 14px;
                padding: 8px 12px;
            }

            footer.nav-bar button {
                padding: 8px 10px;
                font-size: 14px;
            }

            .settings-panel,
            .bookmarks-panel {
                left: 10px;
                right: 10px;
                max-width: none;
            }

            .tafsir-controls {
                flex-direction: column;
                align-items: stretch;
            }

            .tafsir-row {
                flex-wrap: wrap;
                gap: 8px;
            }

            .tafsir-label {
                width: 100%;
                text-align: left;
                margin-bottom: 5px;
            }

            .language-select,
            .tafsir-select {
                min-width: auto;
                flex: 1;
            }

            .tafsir-toggle {
                width: 100%;
                margin-top: 10px;
            }
        }

        @media (max-width: 480px) {
            .header-controls {
                gap: 4px;
            }

            .header-controls button {
                padding: 4px 6px;
                font-size: 11px;
                min-width: 28px;
            }

            .bismillah {
                font-size: 1.5em;
            }

            #arabic {
                font-size: 1.3em;
                line-height: 1.8;
                margin: 15px 0;
            }

            .pronunciation {
                margin: 10px 0;
            }

            .word-table {
                font-size: 0.9em;
            }

            main {
                padding: 10px 5px 120px;
            }

            .word-table th,
            .word-table td {
                padding: 6px;
                font-size: 0.8em;
            }

            .nav-controls {
                gap: 3px;
                padding: 8px;
            }

            .nav-controls button {
                padding: 8px 10px;
                font-size: 13px;
                min-width: 36px;
            }

            .search-container {
                width: 130px;
            }

            #search {
                font-size: 12px;
                padding: 6px 8px;
            }
        }
    </style>
</head>

<body>
    <div class="container">
        <header>
            <div class="header-controls left">
                <button onclick="toggleAutoPlay()" title="Auto-play Surah" id="autoplay-btn">🔄</button>
                <button onclick="toggleSettings()" title="Settings">⚙️</button>
            </div>
            <div class="header-controls">
                <button onclick="toggleBookmarks()" title="Bookmarks">📚</button>
                <button onclick="addBookmark()" title="Add Bookmark">⭐</button>
            </div>
            <div class="bismillah">بِسْمِ ٱللَّهِ ٱلرَّحْمَٰنِ ٱلرَّحِيمِ</div>
            <div class="surah-info">Surah Al-Fatiha | Verse 1</div>
        </header>

        <main>
            <h1 id="arabic" onclick="cycleFontSize()" title="Click to change font size">
                بِسْمِ ٱللَّهِ ٱلرَّحْمَٰنِ ٱلرَّحِيمِ
            </h1>

            <div class="pronunciation">
                <span id="transliteration">Bismillāhir-Raḥmānir-Raḥīm</span>
                <div class="audio-controls">
                    <button class="play-btn" onclick="playAudio()">
                        ▶️ <span>Play Audio</span>
                    </button>
                </div>
            </div>

            <div id="loading" class="loading">Loading word-by-word data</div>

            <table class="word-table">
                <thead>
                    <tr>
                        <th>Arabic</th>
                        <th>Transliteration</th>
                        <th>Translation</th>
                    </tr>
                </thead>
                <tbody id="word-table-body">
                </tbody>
            </table>

            <div class="tafsir">
                <div class="tafsir-controls">
                    <div class="tafsir-row">
                        <label class="tafsir-label"><strong>Tafsir:</strong></label>
                        <select id="tafsir-language" class="language-select" onchange="updateTafsirOptions()">
                            <option value="en" selected>English</option>
                            <option value="ar">Arabic</option>
                            <option value="bn">Bengali</option>
                            <option value="ur">Urdu</option>
                            <option value="ru">Russian</option>
                            <option value="kurd">Kurdish</option>
                        </select>
                        <select id="tafsir-select" class="tafsir-select" onchange="loadTafsir()">
                            <option value="169">Ibn Kathir (Abridged)</option>
                            <option value="168">Ma'arif al-Qur'an</option>
                            <option value="817">Tazkirul Quran</option>
                        </select>
                        <button class="play-btn tafsir-toggle" onclick="toggleTafsir()">Show/Hide</button>
                    </div>
                </div>
                <div id="tafsir-text" class="tafsir-content" style="display: none">
                    Loading tafsir...
                </div>
            </div>
        </main>

        <!-- Settings Panel -->
        <div id="settings-panel" class="settings-panel">
            <h3>Settings</h3>
            <label>
                Night Mode
                <div class="toggle-switch" id="night-mode-toggle" onclick="toggleNightMode()"></div>
            </label>
            <label>
                Auto-play Audio
                <div class="toggle-switch" id="autoplay-toggle" onclick="toggleAutoplay()"></div>
            </label>
            <label>
                Show Transliteration
                <div class="toggle-switch active" id="transliteration-toggle" onclick="toggleTransliteration()"></div>
            </label>
        </div>

        <!-- Bookmarks Panel -->
        <div id="bookmarks-panel" class="bookmarks-panel">
            <h3>Bookmarks</h3>
            <div id="bookmarks-list">
                <p style="text-align: center; color: #666; font-style: italic;">No bookmarks yet. Click ⭐ to add verses!
                </p>
            </div>
        </div>

        <audio id="audioPlayer" preload="auto"></audio>

        <footer class="nav-bar">
            <div class="nav-controls">
                <button onclick="navigateSurah(-1)" title="Previous Surah">&lt;&lt;&lt;</button>
                <button onclick="navigateRuku(-1)" title="Previous Ruku">&lt;&lt;</button>
                <button onclick="navigateVerse(-1)" title="Previous Verse">&lt;</button>
                <div class="search-container">
                    <input type="text" id="search" value="1-1" list="surah-list" onkeyup="handleSearch(event)"
                        onkeydown="if(event.key === 'Enter') navigateToVerse()"
                        placeholder="Search or navigate (e.g., 2-255)" />
                    <datalist id="surah-list"></datalist>
                </div>
                <button onclick="navigateVerse(1)" title="Next Verse">&gt;</button>
                <button onclick="navigateRuku(1)" title="Next Ruku">&gt;&gt;</button>
                <button onclick="navigateSurah(1)" title="Next Surah">&gt;&gt;&gt;</button>
            </div>
        </footer>
    </div>

    <script>
        // Global variables
        let currentAyah = { surah: 1, verse: 1 };
        let surahNames = [];
        let surahNamesArabic = [];
        let verseCounts = [];
        let currentTafsir = 'en.tafisr.ibn-kathir';
        let settings = {
            nightMode: false,
            autoplay: true,
            showTransliteration: true
        };
        let bookmarks = JSON.parse(localStorage.getItem('quran-bookmarks') || '[]');

        // Auto-play variables
        let isAutoPlaying = false;
        let autoPlayTimer = null;
        let autoPlayStartSurah = 1;
        let autoPlayStartVerse = 1;

        // Initialize app
        document.addEventListener('DOMContentLoaded', function () {
            loadSettings();
            loadBookmarks();
            initializeApp();
        });

        // Load settings from localStorage
        function loadSettings() {
            const savedSettings = localStorage.getItem('quran-settings');
            if (savedSettings) {
                settings = { ...settings, ...JSON.parse(savedSettings) };
                applySettings();
            }
        }

        // Apply settings to UI
        function applySettings() {
            if (settings.nightMode) {
                document.body.classList.add('night-mode');
                document.getElementById('night-mode-toggle').classList.add('active');
            }
            if (settings.autoplay) {
                document.getElementById('autoplay-toggle').classList.add('active');
            }
            if (!settings.showTransliteration) {
                document.getElementById('transliteration-toggle').classList.remove('active');
                document.getElementById('transliteration').style.display = 'none';
            }
        }

        // Save settings to localStorage
        function saveSettings() {
            localStorage.setItem('quran-settings', JSON.stringify(settings));
        }

        // Load Surah metadata from API on startup
        function initializeApp() {
            fetch("https://api.alquran.cloud/v1/meta")
                .then((response) => response.json())
                .then((data) => {
                    surahNames = data.data.surahs.references.map((ref) => ref.englishName);
                    surahNamesArabic = data.data.surahs.references.map((ref) => ref.name);
                    verseCounts = data.data.surahs.references.map((ref) => ref.numberOfAyahs);
                    loadVerse(currentAyah.surah, currentAyah.verse);
                    populateDatalist();
                    updateTafsirOptions(); // Initialize tafsir options
                })
                .catch((err) => {
                    console.error("Error fetching metadata:", err);
                    // Fallback data for the first 30 surahs
                    surahNames = [
                        "Al-Fatiha", "Al-Baqarah", "Ali 'Imran", "An-Nisa", "Al-Ma'idah", "Al-An'am", "Al-A'raf", "Al-Anfal", "At-Tawbah", "Yunus",
                        "Hud", "Yusuf", "Ar-Ra'd", "Ibrahim", "Al-Hijr", "An-Nahl", "Al-Isra", "Al-Kahf", "Maryam", "Taha",
                        "Al-Anbya", "Al-Hajj", "Al-Mu'minun", "An-Nur", "Al-Furqan", "Ash-Shu'ara", "An-Naml", "Al-Qasas", "Al-'Ankabut", "Ar-Rum"
                    ];
                    verseCounts = [7, 286, 200, 176, 120, 165, 206, 75, 129, 109, 123, 111, 43, 52, 99, 128, 111, 110, 98, 135, 112, 78, 118, 64, 77, 227, 93, 88, 69, 60];
                    loadVerse(currentAyah.surah, currentAyah.verse);
                    populateDatalist();
                    updateTafsirOptions(); // Initialize tafsir options
                });
        }

        // Populate datalist with surah names
        function populateDatalist() {
            const datalist = document.getElementById('surah-list');
            datalist.innerHTML = '';

            surahNames.forEach((name, index) => {
                const option = document.createElement('option');
                option.value = `${index + 1}-1`;
                option.textContent = `${index + 1}. ${name}`;
                datalist.appendChild(option);
            });
        }

        // Handle search input with enhanced functionality
        function handleSearch(event) {
            const query = event.target.value.toLowerCase().trim();

            // Check if it's a verse reference (e.g., "2-255")
            if (/^\d+-\d+$/.test(query)) {
                return;
            }

            // If it's alphabetic input, filter surahs
            if (/^[a-zA-Z\s]+$/.test(query) && query.length > 0) {
                const datalist = document.getElementById('surah-list');
                datalist.innerHTML = '';

                const filteredSurahs = surahNames.filter((name, index) =>
                    name.toLowerCase().includes(query) ||
                    name.toLowerCase().replace(/['\-\s]/g, '').includes(query.replace(/['\-\s]/g, ''))
                );

                filteredSurahs.forEach((name) => {
                    const index = surahNames.indexOf(name);
                    const option = document.createElement('option');
                    option.value = `${index + 1}-1`;
                    option.textContent = `${index + 1}. ${name}`;
                    datalist.appendChild(option);
                });
            } else if (query.length === 0) {
                // Reset to full list when search is empty
                populateDatalist();
            }
        }

        // Update tafsir options based on selected language
        function updateTafsirOptions() {
            const language = document.getElementById('tafsir-language').value;
            const tafsirSelect = document.getElementById('tafsir-select');

            // Clear existing options
            tafsirSelect.innerHTML = '';

            if (language === 'en') {
                // English tafsirs from Quran.com API
                tafsirSelect.innerHTML = `
                    <option value="169">Ibn Kathir (Abridged)</option>
                    <option value="168">Ma'arif al-Qur'an</option>
                    <option value="817">Tazkirul Quran (Wahiduddin Khan)</option>
                `;
            } else if (language === 'ar') {
                // Arabic tafsirs from AlQuran Cloud API
                tafsirSelect.innerHTML = `
                    <option value="ar.muyassar">تفسير الميسر (King Fahad Complex)</option>
                    <option value="ar.jalalayn">تفسير الجلالين (Jalalayn)</option>
                    <option value="ar.qurtubi">تفسير القرطبي (Al-Qurtubi)</option>
                    <option value="ar.miqbas">تنوير المقباس (Ibn Abbas)</option>
                    <option value="ar.waseet">التفسير الوسيط (Al-Waseet)</option>
                    <option value="ar.baghawi">تفسير البغوي (Al-Baghawi)</option>
                `;
            } else if (language === 'bn') {
                // Bengali tafsirs from Quran.com API
                tafsirSelect.innerHTML = `
                    <option value="381">Tafsir Fathul Majid</option>
                    <option value="165">Tafsir Ahsanul Bayaan</option>
                    <option value="166">Tafsir Abu Bakr Zakaria</option>
                    <option value="164">Tafseer Ibn Kathir</option>
                `;
            } else if (language === 'ur') {
                // Urdu tafsirs from Quran.com API
                tafsirSelect.innerHTML = `
                    <option value="157">Fi Zilal al-Quran (Sayyid Qutb)</option>
                    <option value="160">Tafsir Ibn Kathir</option>
                    <option value="818">Tazkir ul Quran (Wahiduddin Khan)</option>
                    <option value="159">Bayan ul Quran (Dr. Israr Ahmad)</option>
                `;
            } else if (language === 'ru') {
                // Russian tafsirs from Quran.com API
                tafsirSelect.innerHTML = `
                    <option value="170">Al-Sa'di</option>
                `;
            } else if (language === 'kurd') {
                // Kurdish tafsirs from Quran.com API
                tafsirSelect.innerHTML = `
                    <option value="804">Rebar Kurdish Tafsir</option>
                `;
            }

            // Load tafsir for the new selection
            if (tafsirSelect.options.length > 0) {
                loadTafsir();
            }
        }

        // Load tafsir for current verse with better error handling
        function loadTafsir() {
            const selectedTafsir = document.getElementById('tafsir-select').value;
            const language = document.getElementById('tafsir-language').value;
            currentTafsir = selectedTafsir;

            const tafsirText = document.getElementById('tafsir-text');
            tafsirText.innerHTML = 'Loading tafsir...';

            let apiUrl;

            if (language === 'en' || language === 'bn' || language === 'ur' || language === 'ru' || language === 'kurd') {
                // Use Quran.com API for non-Arabic languages
                apiUrl = `https://api.quran.com/api/v4/tafsirs/${selectedTafsir}/by_ayah/${currentAyah.surah}?words=false`;
            } else {
                // Use AlQuran Cloud API for Arabic tafsir
                apiUrl = `https://api.alquran.cloud/v1/ayah/${currentAyah.surah}:${currentAyah.verse}/${selectedTafsir}`;
            }

            fetch(apiUrl)
                .then(response => response.json())
                .then(data => {
                    let tafsirContent = '';
                    let tafsirName = 'Tafsir';

                    if (language === 'en' || language === 'bn' || language === 'ur' || language === 'ru' || language === 'kurd') {
                        // Handle Quran.com API response for all non-Arabic languages
                        const verseKey = `${currentAyah.surah}:${currentAyah.verse}`;
                        if (data.tafsir && data.tafsir.verses && data.tafsir.verses[verseKey]) {
                            const verseData = data.tafsir.verses[verseKey];
                            tafsirContent = verseData.text || data.tafsir.text || '';
                            tafsirName = data.tafsir.resource_name || 'Tafsir';

                            // Clean up HTML tags for better readability
                            tafsirContent = tafsirContent
                                .replace(/<h[1-6][^>]*>/g, '<strong>')
                                .replace(/<\/h[1-6]>/g, '</strong><br>')
                                .replace(/<p[^>]*>/g, '<p>')
                                .replace(/style="[^"]*"/g, '')
                                .replace(/<span[^>]*>/g, '<span>')
                                .trim();
                        }
                    } else {
                        // Handle Arabic tafsir response from AlQuran Cloud
                        if (data.status === 'OK' && data.data && data.data.text) {
                            tafsirContent = data.data.text;
                            tafsirName = data.data.edition?.name || 'تفسير';
                        }
                    }

                    if (tafsirContent) {
                        // Determine text direction based on language
                        let textDirection = '';
                        if (language === 'ar') {
                            textDirection = 'style="direction: rtl; text-align: right;"';
                        } else if (language === 'bn' || language === 'ur') {
                            textDirection = 'style="text-align: justify;"';
                        }

                        tafsirText.innerHTML = `
                            <div class="tafsir-header">
                                <strong>${tafsirName}</strong>
                                <br><em>Verse ${currentAyah.verse} of Surah ${surahNames[currentAyah.surah - 1]}</em>
                            </div>
                            <div class="tafsir-body" ${textDirection}>
                                ${tafsirContent}
                            </div>
                        `;
                    } else {
                        tafsirText.innerHTML = 'Tafsir not available for this verse.';
                    }
                })
                .catch(err => {
                    console.error('Error loading tafsir:', err);
                    // Fallback to a basic explanation
                    tafsirText.innerHTML = `
            <div class="error-message">
              Tafsir service temporarily unavailable. 
              <br><br>
              This is verse ${currentAyah.verse} of Surah ${surahNames[currentAyah.surah - 1]} (${currentAyah.surah}).
              <br><br>
              Please try again later or select a different tafsir option.
            </div>
          `;
                });
        }

        // Load a specific verse with enhanced loading states
        function loadVerse(surah, verse) {
            // Show loading indicator
            const loadingElement = document.getElementById("loading");
            const mainContent = document.querySelector("main");

            loadingElement.style.display = "block";
            if (mainContent) mainContent.style.opacity = "0.7";

            // Add loading states to navigation buttons
            const navButtons = document.querySelectorAll('.nav-btn');
            navButtons.forEach(btn => {
                showLoading(btn, '');
            });

            document.getElementById("search").value = `${surah}-${verse}`;
            currentAyah = { surah, verse };

            // Load audio with loading feedback
            fetch(`https://api.alquran.cloud/v1/ayah/${surah}:${verse}/ar.alafasy`)
                .then(response => response.json())
                .then(audioData => {
                    const audioPlayer = document.getElementById("audioPlayer");
                    if (audioData.data && audioData.data.audio) {
                        currentAyah.audioUrl = audioData.data.audio;
                        audioPlayer.src = currentAyah.audioUrl;

                        // Auto-play if enabled and user has interacted
                        if (settings.autoplay) {
                            setTimeout(() => {
                                if (userHasInteracted) {
                                    playAudio();
                                } else {
                                    showNotification('Auto-play ready! Click anywhere to enable audio.', 'info');
                                }
                            }, 500);
                        }
                    } else {
                        console.warn(`No audio found for Surah ${surah}, Verse ${verse}`);
                        audioPlayer.src = '';
                    }
                })
                .catch(err => {
                    console.error("Error fetching audio URL:", err);
                    document.getElementById("audioPlayer").src = '';
                });

            // Load verse data
            Promise.all([
                fetch(`https://api.alquran.cloud/v1/ayah/${surah}:${verse}/ar`),
                fetch(`https://api.alquran.cloud/v1/ayah/${surah}:${verse}/en.transliteration`),
                fetch(`https://api.alquran.cloud/v1/ayah/${surah}:${verse}/en.sahih`),
            ])
                .then((responses) => Promise.all(responses.map((res) => res.json())))
                .then(([arabicData, translitData, transData]) => {
                    document.getElementById("arabic").innerText = arabicData.data.text;
                    document.getElementById("transliteration").innerText = translitData.data.text;
                    document.querySelector(".surah-info").innerText = `Surah ${surahNames[surah - 1]} | Verse ${verse}`;

                    return fetch(`https://api.quran.com/api/v4/verses/by_key/${surah}:${verse}?words=true&translations=131&word_fields=text_uthmani,transliteration&fields=text_uthmani`)
                        .then((response) => response.json())
                        .catch((err) => {
                            console.error("Error fetching word-by-word data:", err);
                            return null;
                        });
                })
                .then((wordData) => {
                    if (!wordData || !wordData.verse || !wordData.verse.words) {
                        return fallbackWordByWord(surah, verse);
                    }

                    const words = wordData.verse.words;
                    const tbody = document.getElementById("word-table-body");
                    tbody.innerHTML = "";

                    words.forEach((word) => {
                        if (word.char_type_name !== "end") {
                            const row = document.createElement("tr");

                            const arabicCell = document.createElement("td");
                            arabicCell.textContent = word.text_uthmani;
                            arabicCell.dir = "rtl";
                            arabicCell.className = "arabic-word";
                            row.appendChild(arabicCell);

                            const translitCell = document.createElement("td");
                            translitCell.textContent = word.transliteration?.text || "";
                            row.appendChild(translitCell);

                            const transCell = document.createElement("td");
                            transCell.textContent = word.translation?.text || "";
                            row.appendChild(transCell);

                            tbody.appendChild(row);
                        }
                    });

                    // Enhanced loading cleanup
                    const loadingElement = document.getElementById("loading");
                    const mainContent = document.querySelector("main");
                    const navButtons = document.querySelectorAll('.nav-btn');

                    loadingElement.style.display = "none";
                    if (mainContent) mainContent.style.opacity = "1";

                    // Restore navigation buttons
                    navButtons.forEach(btn => {
                        hideLoading(btn);
                    });

                    loadTafsir();
                })
                .catch((err) => {
                    console.error("Error in verse loading process:", err);

                    // Clean up loading states on error
                    const loadingElement = document.getElementById("loading");
                    const mainContent = document.querySelector("main");
                    const navButtons = document.querySelectorAll('.nav-btn');

                    loadingElement.style.display = "none";
                    if (mainContent) mainContent.style.opacity = "1";

                    navButtons.forEach(btn => {
                        hideLoading(btn);
                    });

                    showNotification("Error loading verse. Please try again.", 'error');
                    fallbackWordByWord(surah, verse);
                });
        }

        // Fallback function for word-by-word when API fails
        function fallbackWordByWord(surah, verse) {
            return Promise.all([
                fetch(`https://api.alquran.cloud/v1/ayah/${surah}:${verse}/ar`),
                fetch(`https://api.alquran.cloud/v1/ayah/${surah}:${verse}/en.transliteration`),
                fetch(`https://api.alquran.cloud/v1/ayah/${surah}:${verse}/en.sahih`),
            ])
                .then((responses) => Promise.all(responses.map((res) => res.json())))
                .then(([arabicData, translitData, transData]) => {
                    document.getElementById("arabic").innerText = arabicData.data.text;
                    document.getElementById("transliteration").innerText = translitData.data.text;

                    const arabicWords = arabicData.data.text.split(/\s+/);
                    const translitWords = translitData.data.text.split(/\s+/);
                    const transWords = transData.data.text.split(/\s+/);
                    const maxLength = Math.max(arabicWords.length, translitWords.length, transWords.length);

                    const tbody = document.getElementById("word-table-body");
                    tbody.innerHTML = "";

                    for (let i = 0; i < maxLength; i++) {
                        const row = document.createElement("tr");

                        const arabicCell = document.createElement("td");
                        arabicCell.textContent = arabicWords[i] || "";
                        arabicCell.dir = "rtl";
                        arabicCell.className = "arabic-word";
                        row.appendChild(arabicCell);

                        const translitCell = document.createElement("td");
                        translitCell.textContent = translitWords[i] || "";
                        row.appendChild(translitCell);

                        const transCell = document.createElement("td");
                        transCell.textContent = transWords[i] || "";
                        row.appendChild(transCell);

                        tbody.appendChild(row);
                    }

                    // Enhanced loading cleanup for fallback
                    const loadingElement = document.getElementById("loading");
                    const mainContent = document.querySelector("main");
                    const navButtons = document.querySelectorAll('.nav-btn');

                    loadingElement.style.display = "none";
                    if (mainContent) mainContent.style.opacity = "1";

                    navButtons.forEach(btn => {
                        hideLoading(btn);
                    });

                    loadTafsir();
                    return null;
                })
                .catch((err) => {
                    console.error("Error in fallback word-by-word:", err);

                    // Clean up loading states
                    const loadingElement = document.getElementById("loading");
                    const mainContent = document.querySelector("main");
                    const navButtons = document.querySelectorAll('.nav-btn');

                    loadingElement.style.display = "none";
                    if (mainContent) mainContent.style.opacity = "1";

                    navButtons.forEach(btn => {
                        hideLoading(btn);
                    });

                    showNotification("Error loading verse data. Please try again later.", 'error');
                    return null;
                });
        }

        // Font size cycling
        const fontSizes = [1.8, 2.2, 2.6, 3.0];
        let currentSizeIndex = 0;
        function cycleFontSize() {
            currentSizeIndex = (currentSizeIndex + 1) % fontSizes.length;
            document.getElementById("arabic").style.fontSize = fontSizes[currentSizeIndex] + "em";
        }

        // User interaction detection for audio policy compliance
        let userHasInteracted = false;

        // Track user interactions to enable audio autoplay
        function enableAudioAfterInteraction() {
            if (!userHasInteracted) {
                userHasInteracted = true;
                document.removeEventListener('click', enableAudioAfterInteraction);
                document.removeEventListener('keydown', enableAudioAfterInteraction);
                document.removeEventListener('touchstart', enableAudioAfterInteraction);
            }
        }

        // Add interaction listeners
        document.addEventListener('click', enableAudioAfterInteraction, { once: false });
        document.addEventListener('keydown', enableAudioAfterInteraction, { once: false });
        document.addEventListener('touchstart', enableAudioAfterInteraction, { once: false });

        // Enhanced audio playback with better error handling
        function playAudio() {
            const audioPlayer = document.getElementById("audioPlayer");
            const playBtn = document.querySelector('.play-btn');

            // Add loading state
            if (playBtn) {
                playBtn.disabled = true;
                playBtn.innerHTML = '⏳';
                playBtn.style.opacity = '0.6';
            }

            audioPlayer.onerror = function (e) {
                console.error("Audio playback error:", e);
                resetAudioButton();
                showNotification(`Unable to play audio for Surah ${currentAyah.surah}, Verse ${currentAyah.verse}`, 'warning');
            };

            if (audioPlayer.src) {
                audioPlayer.currentTime = 0;

                // Check if user has interacted before attempting autoplay
                if (!userHasInteracted) {
                    resetAudioButton();
                    showNotification('Please click anywhere on the page first, then try playing audio', 'info');
                    return;
                }

                audioPlayer.play().then(() => {
                    // Success - update button state
                    if (playBtn) {
                        playBtn.innerHTML = '🔊';
                        playBtn.disabled = false;
                        playBtn.style.opacity = '1';
                    }

                    // Reset button after audio finishes
                    audioPlayer.onended = () => {
                        resetAudioButton();
                    };

                }).catch(err => {
                    console.error("Play method error:", err);
                    resetAudioButton();

                    // More user-friendly error handling
                    if (err.name === 'NotAllowedError') {
                        showNotification('Audio autoplay prevented by browser. Click the play button to start audio.', 'info');
                    } else {
                        showNotification(`Audio unavailable: ${err.message}`, 'warning');
                    }
                });
            } else {
                resetAudioButton();
                showNotification("No audio available for this verse.", 'info');
            }
        }

        function resetAudioButton() {
            const playBtn = document.querySelector('.play-btn');
            if (playBtn) {
                playBtn.innerHTML = '▶️';
                playBtn.disabled = false;
                playBtn.style.opacity = '1';
            }
        }

        // Toggle tafsir display
        function toggleTafsir() {
            const tafsirText = document.getElementById("tafsir-text");
            tafsirText.style.display = tafsirText.style.display === "none" ? "block" : "none";
        }

        // Settings functions
        function toggleSettings() {
            const panel = document.getElementById('settings-panel');
            panel.style.display = panel.style.display === 'none' ? 'block' : 'none';

            // Close bookmarks panel if open
            document.getElementById('bookmarks-panel').style.display = 'none';
        }

        function toggleNightMode() {
            settings.nightMode = !settings.nightMode;
            const toggle = document.getElementById('night-mode-toggle');

            if (settings.nightMode) {
                document.body.classList.add('night-mode');
                toggle.classList.add('active');
            } else {
                document.body.classList.remove('night-mode');
                toggle.classList.remove('active');
            }

            saveSettings();
        }

        function toggleAutoplay() {
            settings.autoplay = !settings.autoplay;
            const toggle = document.getElementById('autoplay-toggle');

            if (settings.autoplay) {
                toggle.classList.add('active');
            } else {
                toggle.classList.remove('active');
            }

            saveSettings();
        }

        function toggleTransliteration() {
            settings.showTransliteration = !settings.showTransliteration;
            const toggle = document.getElementById('transliteration-toggle');
            const translitElement = document.getElementById('transliteration');

            if (settings.showTransliteration) {
                toggle.classList.add('active');
                translitElement.style.display = 'inline';
            } else {
                toggle.classList.remove('active');
                translitElement.style.display = 'none';
            }

            saveSettings();
        }

        // Bookmark functions
        function toggleBookmarks() {
            const panel = document.getElementById('bookmarks-panel');
            panel.style.display = panel.style.display === 'none' ? 'block' : 'none';

            // Close settings panel if open
            document.getElementById('settings-panel').style.display = 'none';

            if (panel.style.display === 'block') {
                loadBookmarks();
            }
        }

        function addBookmark() {
            const bookmark = {
                surah: currentAyah.surah,
                verse: currentAyah.verse,
                surahName: surahNames[currentAyah.surah - 1],
                text: document.getElementById('arabic').innerText.substring(0, 50) + '...',
                date: new Date().toLocaleDateString()
            };

            // Check if already bookmarked
            const exists = bookmarks.find(b => b.surah === bookmark.surah && b.verse === bookmark.verse);
            if (exists) {
                showError('This verse is already bookmarked!');
                return;
            }

            bookmarks.push(bookmark);
            localStorage.setItem('quran-bookmarks', JSON.stringify(bookmarks));
            loadBookmarks();

            // Show success message
            const originalText = document.querySelector('[onclick="addBookmark()"]').innerHTML;
            document.querySelector('[onclick="addBookmark()"]').innerHTML = '✅';
            setTimeout(() => {
                document.querySelector('[onclick="addBookmark()"]').innerHTML = originalText;
            }, 1000);
        }

        function loadBookmarks() {
            bookmarks = JSON.parse(localStorage.getItem('quran-bookmarks') || '[]');
            const list = document.getElementById('bookmarks-list');

            if (bookmarks.length === 0) {
                list.innerHTML = '<p style="text-align: center; color: #666; font-style: italic;">No bookmarks yet. Click ⭐ to add verses!</p>';
                return;
            }

            list.innerHTML = bookmarks.map((bookmark, index) => `
        <div class="bookmark-item" onclick="loadVerse(${bookmark.surah}, ${bookmark.verse})">
          <div>
            <strong>${bookmark.surahName} ${bookmark.verse}</strong><br>
            <small>${bookmark.text}</small><br>
            <small style="color: #666;">Added: ${bookmark.date}</small>
          </div>
          <button class="bookmark-delete" onclick="event.stopPropagation(); deleteBookmark(${index})">×</button>
        </div>
      `).join('');
        }

        function deleteBookmark(index) {
            bookmarks.splice(index, 1);
            localStorage.setItem('quran-bookmarks', JSON.stringify(bookmarks));
            loadBookmarks();
        }

        // Navigation functions
        function navigateVerse(direction) {
            let newVerse = currentAyah.verse + direction;
            let newSurah = currentAyah.surah;

            if (newVerse < 1) {
                newSurah--;
                if (newSurah < 1) return;
                newVerse = verseCounts[newSurah - 1];
            } else if (newVerse > verseCounts[currentAyah.surah - 1]) {
                newSurah++;
                if (newSurah > 114) return;
                newVerse = 1;
            }

            loadVerse(newSurah, newVerse);
        }

        function navigateRuku(direction) {
            const offset = 3;
            let newVerse = currentAyah.verse + direction * offset;
            let newSurah = currentAyah.surah;

            if (newVerse < 1) {
                newSurah--;
                if (newSurah < 1) return;
                newVerse = verseCounts[newSurah - 1] + newVerse;
            } else if (newVerse > verseCounts[currentAyah.surah - 1]) {
                newSurah++;
                if (newSurah > 114) return;
                newVerse = newVerse - verseCounts[currentAyah.surah - 1];
            }

            loadVerse(newSurah, newVerse);
        }

        function navigateSurah(direction) {
            let newSurah = currentAyah.surah + direction;
            if (newSurah >= 1 && newSurah <= 114) {
                loadVerse(newSurah, 1);
            }
        }

        function navigateToVerse() {
            const input = document.getElementById("search").value;

            // Check if it's a surah-verse format
            if (input.includes("-")) {
                const parts = input.split("-");
                const surah = parseInt(parts[0]);
                const verse = parseInt(parts[1]);

                if (surah >= 1 && surah <= 114 && verse >= 1 && verse <= verseCounts[surah - 1]) {
                    loadVerse(surah, verse);
                } else {
                    showError("Invalid Surah or Verse number");
                }
            } else {
                // Check if it's a surah name
                const surahIndex = surahNames.findIndex(name =>
                    name.toLowerCase().includes(input.toLowerCase()) ||
                    name.toLowerCase().replace(/['\-\s]/g, '').includes(input.toLowerCase().replace(/['\-\s]/g, ''))
                );

                if (surahIndex !== -1) {
                    loadVerse(surahIndex + 1, 1);
                } else {
                    showError("Invalid search term. Use format 'Surah-Verse' (e.g., 2-255) or Surah name");
                }
            }
        }

        // Auto-play functionality
        function toggleAutoPlay() {
            const autoPlayBtn = document.getElementById('autoplay-btn');

            if (isAutoPlaying) {
                stopAutoPlay();
            } else {
                startAutoPlay();
            }
        }

        function startAutoPlay() {
            isAutoPlaying = true;
            autoPlayStartSurah = currentAyah.surah;
            autoPlayStartVerse = currentAyah.verse;

            const autoPlayBtn = document.getElementById('autoplay-btn');
            autoPlayBtn.innerHTML = '⏸️';
            autoPlayBtn.title = 'Pause Auto-play';

            // Play current verse and set up auto progression
            playCurrentVerseAndContinue();
        }

        function stopAutoPlay() {
            isAutoPlaying = false;

            const autoPlayBtn = document.getElementById('autoplay-btn');
            autoPlayBtn.innerHTML = '🔄';
            autoPlayBtn.title = 'Auto-play Surah';

            if (autoPlayTimer) {
                clearTimeout(autoPlayTimer);
                autoPlayTimer = null;
            }

            // Stop current audio
            const audioPlayer = document.getElementById("audioPlayer");
            audioPlayer.pause();
        }

        function playCurrentVerseAndContinue() {
            if (!isAutoPlaying) return;

            const audioPlayer = document.getElementById("audioPlayer");

            // Play current verse
            if (audioPlayer.src) {
                audioPlayer.currentTime = 0;
                audioPlayer.play().catch(err => {
                    console.error("Auto-play error:", err);
                    stopAutoPlay();
                });

                // When verse finishes, move to next verse
                audioPlayer.onended = function () {
                    if (!isAutoPlaying) return;

                    // Check if we've reached the end of the surah
                    if (currentAyah.verse >= verseCounts[currentAyah.surah - 1]) {
                        stopAutoPlay();
                        showError(`Auto-play completed: Reached end of Surah ${surahNames[currentAyah.surah - 1]}`);
                        return;
                    }

                    // Move to next verse after a short delay
                    autoPlayTimer = setTimeout(() => {
                        if (isAutoPlaying) {
                            navigateVerse(1);
                            // Small delay to allow verse to load, then continue playing
                            setTimeout(() => {
                                if (isAutoPlaying) {
                                    playCurrentVerseAndContinue();
                                }
                            }, 1000);
                        }
                    }, 1500); // 1.5 second pause between verses
                };
            } else {
                // No audio available, skip to next verse
                autoPlayTimer = setTimeout(() => {
                    if (isAutoPlaying) {
                        if (currentAyah.verse >= verseCounts[currentAyah.surah - 1]) {
                            stopAutoPlay();
                            showError(`Auto-play completed: Reached end of Surah ${surahNames[currentAyah.surah - 1]}`);
                            return;
                        }
                        navigateVerse(1);
                        setTimeout(() => {
                            if (isAutoPlaying) {
                                playCurrentVerseAndContinue();
                            }
                        }, 1000);
                    }
                }, 2000); // 2 second delay when no audio
            }
        }

        // Enhanced notification system with better UX
        function showNotification(message, type = 'info', duration = 4000) {
            // Remove existing notifications
            const existingNotifications = document.querySelectorAll('.notification');
            existingNotifications.forEach(notif => {
                notif.style.animation = 'slideOut 0.3s ease-in-out forwards';
                setTimeout(() => notif.remove(), 300);
            });

            // Create new notification
            const notification = document.createElement('div');
            notification.className = `notification notification-${type}`;

            // Set content and icon based on type
            let icon = '';
            switch (type) {
                case 'success': icon = '✅'; break;
                case 'warning': icon = '⚠️'; break;
                case 'error': icon = '❌'; break;
                case 'info':
                default: icon = 'ℹ️'; break;
            }

            notification.innerHTML = `
                <span class="notification-icon">${icon}</span>
                <span class="notification-message">${message}</span>
                <button class="notification-close" onclick="this.parentElement.remove()">×</button>
            `;

            // Add to DOM
            document.body.appendChild(notification);

            // Trigger slide-in animation
            requestAnimationFrame(() => {
                notification.style.animation = 'slideIn 0.3s ease-out forwards';
            });

            // Auto-hide after duration
            setTimeout(() => {
                if (notification.parentElement) {
                    notification.style.animation = 'slideOut 0.3s ease-in-out forwards';
                    setTimeout(() => notification.remove(), 300);
                }
            }, duration);
        }

        // Backward compatibility - replace showError calls
        function showError(message) {
            showNotification(message, 'error');
        }

        // Loading state management
        function showLoading(element, text = 'Loading...') {
            if (element) {
                element.dataset.originalContent = element.innerHTML;
                element.innerHTML = `<span class="loading-spinner"></span> ${text}`;
                element.disabled = true;
                element.style.opacity = '0.7';
            }
        }

        function hideLoading(element) {
            if (element && element.dataset.originalContent) {
                element.innerHTML = element.dataset.originalContent;
                element.disabled = false;
                element.style.opacity = '1';
                delete element.dataset.originalContent;
            }
        }

        // Close panels when clicking outside
        document.addEventListener('click', function (event) {
            const settingsPanel = document.getElementById('settings-panel');
            const bookmarksPanel = document.getElementById('bookmarks-panel');

            if (!event.target.closest('.settings-panel') && !event.target.closest('[onclick="toggleSettings()"]')) {
                settingsPanel.style.display = 'none';
            }

            if (!event.target.closest('.bookmarks-panel') && !event.target.closest('[onclick="toggleBookmarks()"]')) {
                bookmarksPanel.style.display = 'none';
            }
        });

        // Keyboard shortcuts
        document.addEventListener('keydown', function (event) {
            if (event.target.tagName === 'INPUT') return;

            switch (event.key) {
                case 'ArrowLeft':
                    navigateVerse(-1);
                    event.preventDefault();
                    break;
                case 'ArrowRight':
                    navigateVerse(1);
                    event.preventDefault();
                    break;
                case 'ArrowUp':
                    navigateRuku(-1);
                    event.preventDefault();
                    break;
                case 'ArrowDown':
                    navigateRuku(1);
                    event.preventDefault();
                    break;
                case ' ':
                    playAudio();
                    event.preventDefault();
                    break;
                case 'b':
                    addBookmark();
                    event.preventDefault();
                    break;
                case 's':
                    toggleSettings();
                    event.preventDefault();
                    break;
            }
        });
    </script>
</body>

</html>