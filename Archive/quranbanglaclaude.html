<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Quran Reader</title>
    <style>
        :root {
            --primary-color: #1a3c34;
            --secondary-color: #ffd700;
            --text-color: #333;
            --background-color: #f5f5f5;
            --table-border: #ddd;
            --table-header: #f2f2f2;
        }

        body {
            font-family: Arial, sans-serif;
            margin: 0;
            padding: 0;
            background-color: var(--background-color);
            color: var(--text-color);
            transition: background-color 0.3s, color 0.3s;
        }

        .container {
            display: flex;
            flex-direction: column;
            min-height: 100vh;
        }

        header {
            background-color: var(--primary-color);
            color: white;
            text-align: center;
            padding: 10px;
            position: sticky;
            top: 0;
            z-index: 100;
        }

        .bismillah {
            font-size: 2em;
            color: var(--secondary-color);
            text-shadow: 1px 1px 3px #000;
        }

        .surah-info {
            font-size: 1.2em;
            margin-top: 5px;
        }

        main {
            flex: 1;
            padding: 20px;
            text-align: center;
            padding-bottom: 100px;
            /* Make room for the fixed nav bar */
        }

        #arabic {
            cursor: pointer;
            font-size: 1.5em;
            margin-bottom: 10px;
            transition: font-size 0.3s;
        }

        .pronunciation {
            margin: 10px 0;
            font-size: 1.2em;
        }

        .button {
            margin-left: 10px;
            padding: 5px 10px;
            font-size: 1em;
            cursor: pointer;
            background-color: var(--primary-color);
            color: white;
            border: none;
            border-radius: 3px;
            transition: background-color 0.3s;
        }

        .button:hover {
            background-color: #265c50;
        }

        .word-table {
            margin: 20px auto;
            border-collapse: collapse;
            width: 90%;
            box-shadow: 0 2px 5px rgba(0, 0, 0, 0.1);
        }

        .word-table th,
        .word-table td {
            border: 1px solid var(--table-border);
            padding: 8px;
        }

        .word-table th {
            background-color: var(--table-header);
        }

        /* Word-by-word alignment */
        .arabic-word {
            font-size: 1.2em;
            font-family: 'Traditional Arabic', 'Scheherazade', serif;
            text-align: right;
        }

        .word-table td {
            vertical-align: middle;
            padding: 8px 15px;
        }

        .tafsir {
            margin: 20px 0;
            text-align: left;
            border-top: 1px solid #ccc;
            padding-top: 10px;
        }

        footer.nav-bar {
            position: fixed;
            bottom: 0;
            width: 100%;
            background-color: var(--primary-color);
            padding: 10px;
            text-align: center;
            z-index: 100;
        }

        footer.nav-bar button,
        footer.nav-bar input {
            margin: 0 5px;
            padding: 5px 10px;
        }

        /* Loading indicator */
        .loading {
            display: none;
            margin: 20px auto;
            text-align: center;
            font-style: italic;
            color: #666;
        }

        /* Settings panel */
        .settings-panel {
            display: none;
            position: fixed;
            top: 60px;
            right: 10px;
            background-color: white;
            border: 1px solid #ccc;
            border-radius: 5px;
            padding: 15px;
            box-shadow: 0 2px 10px rgba(0, 0, 0, 0.2);
            z-index: 999;
        }

        .settings-panel h3 {
            margin-top: 0;
        }

        .settings-panel label {
            display: block;
            margin: 10px 0;
        }

        /* Bookmark styles */
        .bookmarks-panel {
            display: none;
            position: fixed;
            top: 60px;
            left: 10px;
            background-color: white;
            border: 1px solid #ccc;
            border-radius: 5px;
            padding: 15px;
            box-shadow: 0 2px 10px rgba(0, 0, 0, 0.2);
            z-index: 999;
            max-height: 80vh;
            overflow-y: auto;
            min-width: 200px;
        }

        .bookmark-item {
            padding: 5px 0;
            border-bottom: 1px solid #eee;
            cursor: pointer;
        }

        .bookmark-item:hover {
            background-color: #f5f5f5;
        }

        /* Error message */
        .error-message {
            background-color: #ffdddd;
            color: #990000;
            padding: 10px;
            margin: 10px 0;
            border-radius: 5px;
            text-align: left;
        }

        /* Night mode */
        body.night-mode {
            --background-color: #121212;
            --text-color: #e0e0e0;
            --table-border: #333;
            --table-header: #2a2a2a;
            --primary-color: #113025;
        }

        body.night-mode .settings-panel,
        body.night-mode .bookmarks-panel {
            background-color: #2a2a2a;
            color: #e0e0e0;
        }

        body.night-mode .bookmark-item:hover {
            background-color: #3a3a3a;
        }

        /* Responsive design */
        @media (max-width: 768px) {
            .word-table {
                font-size: 0.9em;
            }

            .nav-bar button {
                padding: 6px;
                margin: 2px;
                font-size: 0.9em;
            }

            #arabic {
                font-size: 1.3em;
            }

            .bismillah {
                font-size: 1.5em;
            }

            main {
                padding: 10px;
                padding-bottom: 70px;
            }
        }
    </style>
</head>

<body>
    <div class="container">
        <!-- Header -->
        <header>
            <div class="bismillah">بِسْمِ ٱللَّهِ ٱلرَّحْمَٰنِ ٱلرَّحِيمِ</div>
            <div class="surah-info">Surah Al-Fatiha | Verse 1 | Ruku 1</div>
        </header>

        <!-- Main Content -->
        <main>
            <!-- Arabic Text (clickable to cycle font size) -->
            <h1 id="arabic" onclick="cycleFontSize()">بِسْمِ ٱللَّهِ ٱلرَّحْمَٰنِ ٱلرَّحِيمِ</h1>

            <!-- Pronunciation and Audio Playback -->
            <div class="pronunciation">
                <span id="transliteration">Bismillāhir-Raḥmānir-Raḥīm</span>
                <button onclick="playAudio()">▶️ Play Audio</button>
            </div>

            <!-- Loading indicator -->
            <div id="loading" class="loading">Loading word-by-word data...</div>

            <!-- Word-by-Word Translation Table -->
            <table class="word-table">
                <thead>
                    <tr>
                        <th>Arabic</th>
                        <th>Transliteration</th>
                        <th>Translation</th>
                    </tr>
                </thead>
                <tbody id="word-table-body">
                    <!-- Populated dynamically -->
                </tbody>
            </table>

            <!-- Tafsir Section (moved below the table) -->
            <div class="tafsir">
                <button onclick="toggleTafsir()">Show/Hide Tafsir</button>
                <p id="tafsir-text" style="display: none;">
                    This opening verse, the Basmalah, is a declaration of intent and invocation that precedes every
                    chapter of the Quran except Surah At-Tawbah.
                    'Bismi' signifies starting with Allah's remembrance. 'Allāh' is His unique name.
                    'Ar-Raḥmān' reflects universal mercy and 'Ar-Raḥīm' denotes specific mercy for believers.
                    Per Ibn Kathir, it's a Sunnah before acts, symbolizing divine reliance.
                </p>
            </div>
        </main>

        <!-- Hidden Audio Element -->
        <audio id="audioPlayer" src="https://cdn.alquran.cloud/media/audio/ayah/ar.alafasy/1" preload="auto"></audio>

        <!-- Navigation Bar -->
        <footer class="nav-bar">
            <button onclick="navigateSurah(-1)">
                <<<<< /button>
                    <button onclick="navigateRuku(-1)">
                        <<<< /button>
                            <button onclick="navigateVerse(-1)">
                                <<< /button>
                                    <input type="text" id="search" value="1-1"
                                        onkeydown="if(event.key === 'Enter') navigateToVerse()" />
                                    <button onclick="navigateVerse(1)">></button>
                                    <button onclick="navigateRuku(1)">>></button>
                                    <button onclick="navigateSurah(1)">>>></button>
        </footer>
    </div>

    <script>
        // Global variables
        let currentAyah = { surah: 1, verse: 1 };
        let surahNames = [];
        let verseCounts = [];

        // Load Surah metadata from API on startup
        fetch('https://api.alquran.cloud/v1/meta')
            .then(response => response.json())
            .then(data => {
                surahNames = data.data.surahs.references.map(ref => ref.englishName);
                verseCounts = data.data.surahs.references.map(ref => ref.numberOfAyahs);
                loadVerse(currentAyah.surah, currentAyah.verse);
            })
            .catch(err => console.error('Error fetching metadata:', err));

        // Load a specific verse (Arabic, transliteration, translation) and update the UI
        function loadVerse(surah, verse) {
            // Show loading indicator
            document.getElementById('loading').style.display = 'block';

            // Update the search input and current ayah tracking
            document.getElementById('search').value = `${surah}-${verse}`;
            currentAyah = {
                surah,
                verse,
                audioUrl: `https://cdn.alquran.cloud/media/audio/ayah/ar.alafasy/${(surah - 1) * 1000 + verse}`
            };

            // Update the audio player source
            document.getElementById('audioPlayer').src = currentAyah.audioUrl;

            // First, fetch the basic verse data (arabic, transliteration, translation)
            Promise.all([
                fetch(`https://api.alquran.cloud/v1/ayah/${surah}:${verse}/ar`),
                fetch(`https://api.alquran.cloud/v1/ayah/${surah}:${verse}/en.transliteration`),
                fetch(`https://api.alquran.cloud/v1/ayah/${surah}:${verse}/en.sahih`)
            ])
                .then(responses => Promise.all(responses.map(res => res.json())))
                .then(([arabicData, translitData, transData]) => {
                    // Update Arabic text
                    document.getElementById('arabic').innerText = arabicData.data.text;

                    // Update the transliteration text in the pronunciation section
                    document.getElementById('transliteration').innerText = translitData.data.text;

                    // Update header information
                    document.querySelector('.surah-info').innerText = `Surah ${surahNames[surah - 1]} | Verse ${verse}`;

                    // Now fetch the word-by-word data from Quran.com API
                    return fetch(`https://api.quran.com/api/v4/verses/by_key/${surah}:${verse}?words=true&translations=131&word_fields=text_uthmani,transliteration&fields=text_uthmani`)
                        .then(response => response.json())
                        .catch(err => {
                            console.error('Error fetching word-by-word data:', err);
                            // Return null to indicate we should use fallback
                            return null;
                        });
                })
                .then(wordData => {
                    if (!wordData || !wordData.verse || !wordData.verse.words) {
                        // Use fallback method if we couldn't get word-by-word data
                        return fallbackWordByWord(surah, verse);
                    }

                    const words = wordData.verse.words;

                    // Update word-by-word table dynamically
                    const tbody = document.getElementById('word-table-body');
                    tbody.innerHTML = '';

                    words.forEach(word => {
                        if (word.char_type_name !== 'end') { // Skip end-of-verse markers
                            const row = document.createElement('tr');

                            // Arabic word
                            const arabicCell = document.createElement('td');
                            arabicCell.textContent = word.text_uthmani;
                            arabicCell.dir = 'rtl'; // Set direction to right-to-left
                            arabicCell.className = 'arabic-word';
                            row.appendChild(arabicCell);

                            // Transliteration
                            const translitCell = document.createElement('td');
                            translitCell.textContent = word.transliteration?.text || '';
                            row.appendChild(translitCell);

                            // Translation
                            const transCell = document.createElement('td');
                            transCell.textContent = word.translation?.text || '';
                            row.appendChild(transCell);

                            tbody.appendChild(row);
                        }
                    });

                    // Hide loading indicator
                    document.getElementById('loading').style.display = 'none';

                    // Also fetch and update the tafsir
                    return fetch(`https://api.quran.com/api/v4/tafsirs/en-tafisr-ibn-kathir/by_ayah/${surah}:${verse}`)
                        .then(response => response.json())
                        .catch(err => {
                            console.error('Error fetching tafsir:', err);
                            return { tafsirs: [{ text: 'Tafsir not available for this verse.' }] };
                        });
                })
                .then(tafsirData => {
                    if (tafsirData && tafsirData.tafsirs && tafsirData.tafsirs.length > 0) {
                        document.getElementById('tafsir-text').innerHTML = tafsirData.tafsirs[0].text;
                    } else {
                        document.getElementById('tafsir-text').innerHTML = 'Tafsir not available for this verse.';
                    }
                })
                .catch(err => {
                    console.error('Error in verse loading process:', err);
                    // Fallback to basic word splitting as a last resort
                    fallbackWordByWord(surah, verse);
                });
        }

        // Fallback function for word-by-word when API fails
        function fallbackWordByWord(surah, verse) {
            return Promise.all([
                fetch(`https://api.alquran.cloud/v1/ayah/${surah}:${verse}/ar`),
                fetch(`https://api.alquran.cloud/v1/ayah/${surah}:${verse}/en.transliteration`),
                fetch(`https://api.alquran.cloud/v1/ayah/${surah}:${verse}/en.sahih`)
            ])
                .then(responses => Promise.all(responses.map(res => res.json())))
                .then(([arabicData, translitData, transData]) => {
                    // Update Arabic text if not already updated
                    document.getElementById('arabic').innerText = arabicData.data.text;
                    document.getElementById('transliteration').innerText = translitData.data.text;

                    // Split the text into words
                    const arabicWords = arabicData.data.text.split(/\s+/);
                    const translitWords = translitData.data.text.split(/\s+/);
                    const transWords = transData.data.text.split(/\s+/);

                    // Get the maximum length to ensure we have enough cells
                    const maxLength = Math.max(arabicWords.length, translitWords.length, transWords.length);

                    // Update the table
                    const tbody = document.getElementById('word-table-body');
                    tbody.innerHTML = '';

                    for (let i = 0; i < maxLength; i++) {
                        const row = document.createElement('tr');

                        // Arabic word
                        const arabicCell = document.createElement('td');
                        arabicCell.textContent = arabicWords[i] || '';
                        arabicCell.dir = 'rtl'; // Set direction to right-to-left
                        arabicCell.className = 'arabic-word';
                        row.appendChild(arabicCell);

                        // Transliteration
                        const translitCell = document.createElement('td');
                        translitCell.textContent = translitWords[i] || '';
                        row.appendChild(translitCell);

                        // Translation (this is approximate and may not match perfectly)
                        const transCell = document.createElement('td');
                        transCell.textContent = transWords[i] || '';
                        row.appendChild(transCell);

                        tbody.appendChild(row);
                    }

                    // Hide loading indicator
                    document.getElementById('loading').style.display = 'none';

                    // Return null to indicate we have no tafsir data
                    return null;
                })
                .catch(err => {
                    console.error('Error in fallback word-by-word:', err);
                    document.getElementById('loading').style.display = 'none';
                    alert('Error loading verse data. Please try again later.');
                    return null;
                });
        }

        // Font size cycling: Small, Medium, Large (in em units)
        const fontSizes = [1.5, 2, 2.5];
        let currentSizeIndex = 0;
        function cycleFontSize() {
            currentSizeIndex = (currentSizeIndex + 1) % fontSizes.length;
            document.getElementById('arabic').style.fontSize = fontSizes[currentSizeIndex] + 'em';
        }

        // Audio Playback using the hidden audio element
        function playAudio() {
            const audioPlayer = document.getElementById('audioPlayer');
            audioPlayer.src = currentAyah.audioUrl;
            audioPlayer.currentTime = 0;
            audioPlayer.play();
        }

        // Toggle the display of the Tafsir text
        function toggleTafsir() {
            const tafsirText = document.getElementById('tafsir-text');
            tafsirText.style.display = tafsirText.style.display === 'none' ? 'block' : 'none';
        }

        // Navigation: Previous/Next Verse
        function navigateVerse(direction) {
            let newVerse = currentAyah.verse + direction;
            let newSurah = currentAyah.surah;
            if (newVerse < 1) {
                newSurah--;
                if (newSurah < 1) return;
                newVerse = verseCounts[newSurah - 1];
            } else if (newVerse > verseCounts[currentAyah.surah - 1]) {
                newSurah++;
                if (newSurah > 114) return;
                newVerse = 1;
            }
            loadVerse(newSurah, newVerse);
        }

        // Navigation: Simulated Previous/Next Ruku (approx. 3 verses per Ruku)
        function navigateRuku(direction) {
            const offset = 3;
            let newVerse = currentAyah.verse + direction * offset;
            let newSurah = currentAyah.surah;
            if (newVerse < 1) {
                newSurah--;
                if (newSurah < 1) return;
                newVerse = verseCounts[newSurah - 1] + newVerse; // newVerse is negative here
            } else if (newVerse > verseCounts[currentAyah.surah - 1]) {
                newSurah++;
                if (newSurah > 114) return;
                newVerse = newVerse - verseCounts[currentAyah.surah - 1];
            }
            loadVerse(newSurah, newVerse);
        }

        // Navigation: Previous/Next Surah (loads first verse of that Surah)
        function navigateSurah(direction) {
            let newSurah = currentAyah.surah + direction;
            if (newSurah >= 1 && newSurah <= 114) {
                loadVerse(newSurah, 1);
            }
        }

        // Navigate based on search input (format: "surah-verse")
        function navigateToVerse() {
            const input = document.getElementById('search').value.split('-');
            const surah = parseInt(input[0]);
            const verse = parseInt(input[1]);
            if (surah >= 1 && surah <= 114 && verse >= 1 && verse <= verseCounts[surah - 1]) {
                loadVerse(surah, verse);
            } else {
                alert('Invalid Surah or Verse number');
            }
        }
    </script>
</body>

</html>