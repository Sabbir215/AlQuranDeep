<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Deep Al-Quran - Understand the Quran Deeply</title>
    <style>
        :root {
            --primary-color: #1a3c34;
            --secondary-color: #ffd700;
            --text-color: #333;
            --background-color: #f5f5f5;
            --table-border: #ddd;
            --table-header: #f2f2f2;
        }

        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            margin: 0;
            padding: 0;
            background-color: var(--background-color);
            color: var(--text-color);
            transition: background-color 0.3s, color 0.3s;
        }

        .container {
            display: flex;
            flex-direction: column;
            min-height: 100vh;
        }

        header {
            background-color: var(--primary-color);
            color: white;
            text-align: center;
            padding: 15px 10px;
            position: sticky;
            top: 0;
            z-index: 100;
            box-shadow: 0 2px 5px rgba(0, 0, 0, 0.1);
        }

        .header-controls {
            position: absolute;
            top: 10px;
            right: 15px;
            display: flex;
            gap: 10px;
        }

        .header-controls button {
            background: rgba(255, 255, 255, 0.2);
            border: none;
            color: white;
            padding: 8px 12px;
            border-radius: 5px;
            cursor: pointer;
            font-size: 14px;
            transition: background-color 0.3s;
        }

        .header-controls button:hover {
            background: rgba(255, 255, 255, 0.3);
        }

        .bismillah {
            font-size: 2.2em;
            color: var(--secondary-color);
            text-shadow: 2px 2px 4px rgba(0, 0, 0, 0.5);
            margin-bottom: 5px;
        }

        .surah-info {
            font-size: 1.3em;
            margin-top: 5px;
            opacity: 0.9;
        }

        main {
            flex: 1;
            padding: 20px;
            text-align: center;
            padding-bottom: 120px;
            max-width: 1200px;
            margin: 0 auto;
        }

        #arabic {
            cursor: pointer;
            font-size: 1.8em;
            margin: 20px 0;
            transition: font-size 0.3s, color 0.3s;
            font-family: 'Traditional Arabic', 'Scheherazade', 'Amiri', serif;
            line-height: 1.6;
            color: var(--primary-color);
            user-select: text;
        }

        #arabic:hover {
            color: var(--secondary-color);
        }

        .pronunciation {
            margin: 15px 0;
            font-size: 1.3em;
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 15px;
            flex-wrap: wrap;
        }

        .audio-controls {
            display: flex;
            align-items: center;
            gap: 10px;
        }

        .play-btn {
            background: linear-gradient(135deg, var(--primary-color), #2a5d52);
            color: white;
            border: none;
            padding: 10px 15px;
            border-radius: 25px;
            cursor: pointer;
            font-size: 16px;
            display: flex;
            align-items: center;
            gap: 8px;
            transition: all 0.3s ease;
            box-shadow: 0 2px 10px rgba(0, 0, 0, 0.1);
        }

        .play-btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 4px 15px rgba(0, 0, 0, 0.2);
        }

        .word-table {
            margin: 30px auto;
            border-collapse: collapse;
            width: 95%;
            box-shadow: 0 4px 15px rgba(0, 0, 0, 0.1);
            border-radius: 10px;
            overflow: hidden;
            background: white;
        }

        .word-table th,
        .word-table td {
            border: 1px solid var(--table-border);
            padding: 12px 15px;
        }

        .word-table th {
            background: linear-gradient(135deg, var(--table-header), #e8e8e8);
            font-weight: 600;
            text-transform: uppercase;
            letter-spacing: 0.5px;
            font-size: 14px;
        }

        .arabic-word {
            font-size: 1.4em;
            font-family: 'Traditional Arabic', 'Scheherazade', 'Amiri', serif;
            text-align: right;
            color: var(--primary-color);
            font-weight: 500;
        }

        .word-table td {
            vertical-align: middle;
            transition: background-color 0.2s;
        }

        .word-table tr:hover {
            background-color: #f8f9fa;
        }

        .tafsir {
            margin: 30px 0;
            text-align: left;
            border-top: 2px solid var(--primary-color);
            padding-top: 20px;
        }

        .tafsir-controls {
            display: flex;
            align-items: center;
            gap: 15px;
            margin-bottom: 15px;
            flex-wrap: wrap;
        }

        .tafsir-selector {
            display: flex;
            align-items: center;
            gap: 10px;
        }

        .tafsir-selector select {
            padding: 8px 12px;
            font-size: 14px;
            border: 2px solid var(--table-border);
            border-radius: 5px;
            background: white;
            cursor: pointer;
            transition: border-color 0.3s;
        }

        .tafsir-selector select:focus {
            border-color: var(--primary-color);
            outline: none;
        }

        .tafsir-content {
            background: linear-gradient(135deg, #f9f9f9, #ffffff);
            padding: 20px;
            border-radius: 10px;
            margin-top: 15px;
            line-height: 1.8;
            border-left: 4px solid var(--secondary-color);
            box-shadow: 0 2px 10px rgba(0, 0, 0, 0.05);
        }

        .search-container {
            position: relative;
            display: inline-block;
            width: 250px;
        }

        #search {
            width: 100%;
            padding: 8px 15px;
            font-size: 14px;
            border: 2px solid #ddd;
            border-radius: 25px;
            box-sizing: border-box;
            transition: all 0.3s ease;
        }

        #search:focus {
            border-color: var(--primary-color);
            outline: none;
            box-shadow: 0 0 0 3px rgba(26, 60, 52, 0.1);
        }

        footer.nav-bar {
            position: fixed;
            bottom: 0;
            width: 100%;
            background: linear-gradient(135deg, var(--primary-color), #2a5d52);
            padding: 15px 10px;
            text-align: center;
            z-index: 100;
            box-shadow: 0 -2px 10px rgba(0, 0, 0, 0.1);
        }

        .nav-controls {
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 10px;
            flex-wrap: wrap;
        }

        footer.nav-bar button {
            background: rgba(255, 255, 255, 0.15);
            border: none;
            color: white;
            padding: 10px 15px;
            border-radius: 5px;
            cursor: pointer;
            font-size: 16px;
            font-weight: 500;
            transition: all 0.3s ease;
        }

        footer.nav-bar button:hover {
            background: rgba(255, 255, 255, 0.25);
            transform: translateY(-1px);
        }

        .loading {
            display: none;
            margin: 30px auto;
            text-align: center;
            font-style: italic;
            color: #666;
            font-size: 18px;
        }

        .loading::after {
            content: '...';
            animation: dots 1.5s steps(5, end) infinite;
        }

        @keyframes dots {

            0%,
            20% {
                color: transparent;
                text-shadow: .25em 0 0 transparent, .5em 0 0 transparent;
            }

            40% {
                color: #666;
                text-shadow: .25em 0 0 transparent, .5em 0 0 transparent;
            }

            60% {
                text-shadow: .25em 0 0 #666, .5em 0 0 transparent;
            }

            80%,
            100% {
                text-shadow: .25em 0 0 #666, .5em 0 0 #666;
            }
        }

        /* Settings Panel */
        .settings-panel {
            display: none;
            position: fixed;
            top: 80px;
            right: 15px;
            background: white;
            border: none;
            border-radius: 10px;
            padding: 20px;
            box-shadow: 0 10px 30px rgba(0, 0, 0, 0.2);
            z-index: 999;
            min-width: 250px;
        }

        .settings-panel h3 {
            margin-top: 0;
            color: var(--primary-color);
            border-bottom: 2px solid var(--secondary-color);
            padding-bottom: 10px;
        }

        .settings-panel label {
            display: flex;
            align-items: center;
            justify-content: space-between;
            margin: 15px 0;
            cursor: pointer;
            font-weight: 500;
        }

        .toggle-switch {
            position: relative;
            width: 50px;
            height: 24px;
            background: #ccc;
            border-radius: 12px;
            transition: background 0.3s;
        }

        .toggle-switch.active {
            background: var(--primary-color);
        }

        .toggle-switch::after {
            content: '';
            position: absolute;
            top: 2px;
            left: 2px;
            width: 20px;
            height: 20px;
            background: white;
            border-radius: 10px;
            transition: transform 0.3s;
        }

        .toggle-switch.active::after {
            transform: translateX(26px);
        }

        /* Bookmarks Panel */
        .bookmarks-panel {
            display: none;
            position: fixed;
            top: 80px;
            left: 15px;
            background: white;
            border: none;
            border-radius: 10px;
            padding: 20px;
            box-shadow: 0 10px 30px rgba(0, 0, 0, 0.2);
            z-index: 999;
            max-height: 70vh;
            overflow-y: auto;
            min-width: 280px;
        }

        .bookmarks-panel h3 {
            margin-top: 0;
            color: var(--primary-color);
            border-bottom: 2px solid var(--secondary-color);
            padding-bottom: 10px;
        }

        .bookmark-item {
            padding: 12px;
            border-bottom: 1px solid #eee;
            cursor: pointer;
            border-radius: 5px;
            margin-bottom: 5px;
            transition: all 0.2s;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .bookmark-item:hover {
            background: #f8f9fa;
            transform: translateX(5px);
        }

        .bookmark-delete {
            background: #ff4757;
            color: white;
            border: none;
            border-radius: 3px;
            padding: 4px 8px;
            cursor: pointer;
            font-size: 12px;
        }

        .error-message {
            background: linear-gradient(135deg, #ffebee, #ffcdd2);
            color: #c62828;
            padding: 15px;
            margin: 15px 0;
            border-radius: 8px;
            border-left: 4px solid #f44336;
            text-align: left;
        }

        /* Night Mode */
        body.night-mode {
            --background-color: #121212;
            --text-color: #e0e0e0;
            --table-border: #333;
            --table-header: #2a2a2a;
            --primary-color: #2d5a4f;
        }

        body.night-mode .settings-panel,
        body.night-mode .bookmarks-panel {
            background: #1e1e1e;
            color: #e0e0e0;
        }

        body.night-mode .word-table {
            background: #1e1e1e;
        }

        body.night-mode .bookmark-item:hover {
            background: #2a2a2a;
        }

        body.night-mode .tafsir-content {
            background: linear-gradient(135deg, #1e1e1e, #2a2a2a);
        }

        body.night-mode #search {
            background: #2a2a2a;
            color: #e0e0e0;
            border-color: #444;
        }

        /* Responsive Design */
        @media (max-width: 768px) {
            .header-controls {
                position: static;
                justify-content: center;
                margin-top: 10px;
            }

            .bismillah {
                font-size: 1.8em;
            }

            .surah-info {
                font-size: 1.1em;
            }

            main {
                padding: 15px 10px 120px;
            }

            #arabic {
                font-size: 1.5em;
            }

            .word-table {
                width: 100%;
                font-size: 0.9em;
            }

            .pronunciation {
                flex-direction: column;
                gap: 10px;
            }

            .nav-controls {
                gap: 5px;
            }

            footer.nav-bar button {
                padding: 8px 10px;
                font-size: 14px;
            }

            .search-container {
                width: 180px;
            }

            .settings-panel,
            .bookmarks-panel {
                left: 10px;
                right: 10px;
                max-width: none;
            }

            .tafsir-controls {
                flex-direction: column;
                align-items: stretch;
            }
        }

        @media (max-width: 480px) {
            .bismillah {
                font-size: 1.5em;
            }

            #arabic {
                font-size: 1.3em;
            }

            main {
                padding: 10px 5px 120px;
            }

            .word-table th,
            .word-table td {
                padding: 8px;
                font-size: 0.85em;
            }

            .nav-controls {
                flex-direction: column;
                gap: 8px;
            }

            .search-container {
                width: 200px;
            }
        }
    </style>
</head>

<body>
    <div class="container">
        <header>
            <div class="header-controls">
                <button onclick="toggleBookmarks()" title="Bookmarks">📚</button>
                <button onclick="addBookmark()" title="Add Bookmark">⭐</button>
                <button onclick="toggleSettings()" title="Settings">⚙️</button>
            </div>
            <div class="bismillah">بِسْمِ ٱللَّهِ ٱلرَّحْمَٰنِ ٱلرَّحِيمِ</div>
            <div class="surah-info">Surah Al-Fatiha | Verse 1</div>
        </header>

        <main>
            <h1 id="arabic" onclick="cycleFontSize()" title="Click to change font size">
                بِسْمِ ٱللَّهِ ٱلرَّحْمَٰنِ ٱلرَّحِيمِ
            </h1>

            <div class="pronunciation">
                <span id="transliteration">Bismillāhir-Raḥmānir-Raḥīm</span>
                <div class="audio-controls">
                    <button class="play-btn" onclick="playAudio()">
                        ▶️ <span>Play Audio</span>
                    </button>
                </div>
            </div>

            <div id="loading" class="loading">Loading word-by-word data</div>

            <table class="word-table">
                <thead>
                    <tr>
                        <th>Arabic</th>
                        <th>Transliteration</th>
                        <th>Translation</th>
                    </tr>
                </thead>
                <tbody id="word-table-body">
                </tbody>
            </table>

            <div class="tafsir">
                <div class="tafsir-controls">
                    <div class="tafsir-selector">
                        <label for="tafsir-select"><strong>Select Tafsir:</strong></label>
                        <select id="tafsir-select" onchange="loadTafsir()">
                            <option value="en.tafisr.ibn-kathir">Ibn Kathir (English)</option>
                            <option value="en.tafsir.maarif-ul-quran">Maarif-ul-Quran (English)</option>
                            <option value="en.tafsir.al-jalalayn">Al-Jalalayn (English)</option>
                        </select>
                    </div>
                    <button class="play-btn" onclick="toggleTafsir()">Show/Hide Tafsir</button>
                </div>
                <div id="tafsir-text" class="tafsir-content" style="display: none">
                    Loading tafsir...
                </div>
            </div>
        </main>

        <!-- Settings Panel -->
        <div id="settings-panel" class="settings-panel">
            <h3>Settings</h3>
            <label>
                Night Mode
                <div class="toggle-switch" id="night-mode-toggle" onclick="toggleNightMode()"></div>
            </label>
            <label>
                Auto-play Audio
                <div class="toggle-switch" id="autoplay-toggle" onclick="toggleAutoplay()"></div>
            </label>
            <label>
                Show Transliteration
                <div class="toggle-switch active" id="transliteration-toggle" onclick="toggleTransliteration()"></div>
            </label>
        </div>

        <!-- Bookmarks Panel -->
        <div id="bookmarks-panel" class="bookmarks-panel">
            <h3>Bookmarks</h3>
            <div id="bookmarks-list">
                <p style="text-align: center; color: #666; font-style: italic;">No bookmarks yet. Click ⭐ to add verses!
                </p>
            </div>
        </div>

        <audio id="audioPlayer" preload="auto"></audio>

        <footer class="nav-bar">
            <div class="nav-controls">
                <button onclick="navigateSurah(-1)" title="Previous Surah">&lt;&lt;&lt;</button>
                <button onclick="navigateRuku(-1)" title="Previous Ruku">&lt;&lt;</button>
                <button onclick="navigateVerse(-1)" title="Previous Verse">&lt;</button>
                <div class="search-container">
                    <input type="text" id="search" value="1-1" list="surah-list" onkeyup="handleSearch(event)"
                        onkeydown="if(event.key === 'Enter') navigateToVerse()"
                        placeholder="Search or navigate (e.g., 2-255)" />
                    <datalist id="surah-list"></datalist>
                </div>
                <button onclick="navigateVerse(1)" title="Next Verse">&gt;</button>
                <button onclick="navigateRuku(1)" title="Next Ruku">&gt;&gt;</button>
                <button onclick="navigateSurah(1)" title="Next Surah">&gt;&gt;&gt;</button>
            </div>
        </footer>
    </div>

    <script>
        }

        .word - table th {
            background - color: var(--table - header);
        }

        /* Word-by-word alignment */
        .arabic - word {
            font - size: 1.2em;
            font - family: "Traditional Arabic", "Scheherazade", serif;
            text - align: right;
        }

        .word - table td {
            vertical - align: middle;
            padding: 8px 15px;
        }

        .tafsir {
            margin: 20px 0;
            text - align: left;
            border - top: 1px solid #ccc;
            padding - top: 10px;
        }

        footer.nav - bar {
            position: fixed;
            bottom: 0;
            width: 100 %;
            background - color: var(--primary - color);
            padding: 10px;
            text - align: center;
            z - index: 100;
        }

        footer.nav - bar button,
            footer.nav - bar input {
            margin: 0 5px;
            padding: 5px 10px;
        }

        /* Loading indicator */
        .loading {
            display: none;
            margin: 20px auto;
            text - align: center;
            font - style: italic;
            color: #666;
        }

        /* Settings panel */
        .settings - panel {
            display: none;
            position: fixed;
            top: 60px;
            right: 10px;
            background - color: white;
            border: 1px solid #ccc;
            border - radius: 5px;
            padding: 15px;
            box - shadow: 0 2px 10px rgba(0, 0, 0, 0.2);
            z - index: 999;
        }

        .settings - panel h3 {
            margin - top: 0;
        }

        .settings - panel label {
            display: block;
            margin: 10px 0;
        }

        /* Bookmark styles */
        .bookmarks - panel {
            display: none;
            position: fixed;
            top: 60px;
            left: 10px;
            background - color: white;
            border: 1px solid #ccc;
            border - radius: 5px;
            padding: 15px;
            box - shadow: 0 2px 10px rgba(0, 0, 0, 0.2);
            z - index: 999;
            max - height: 80vh;
            overflow - y: auto;
            min - width: 200px;
        }

        .bookmark - item {
            padding: 5px 0;
            border - bottom: 1px solid #eee;
            cursor: pointer;
        }

        .bookmark - item:hover {
            background - color: #f5f5f5;
        }

        /* Error message */
        .error - message {
            background - color: #ffdddd;
            color: #990000;
            padding: 10px;
            margin: 10px 0;
            border - radius: 5px;
            text - align: left;
        }

        /* Night mode */
        body.night - mode {
            --background - color: #121212;
            --text - color: #e0e0e0;
            --table - border: #333;
            --table - header: #2a2a2a;
            --primary - color: #113025;
        }

        body.night - mode.settings - panel,
            body.night - mode.bookmarks - panel {
            background - color: #2a2a2a;
            color: #e0e0e0;
        }

        body.night - mode.bookmark - item:hover {
            background - color: #3a3a3a;
        }

        /* Responsive design */
        @media(max - width: 768px) {
            .word - table {
                font - size: 0.9em;
            }

            .nav - bar button {
                padding: 6px;
                margin: 2px;
                font - size: 0.9em;
            }

            #arabic {
                font - size: 1.3em;
            }

            .bismillah {
                font - size: 1.5em;
            }

            main {
                padding: 10px;
                padding - bottom: 70px;
            }
        }
    </style >
</head >

            <body>
                <div class="container">
        <!-- Header -->
                    <header>
                        <div class="bismillah">بِسْمِ ٱللَّهِ ٱلرَّحْمَٰنِ ٱلرَّحِيمِ</div>
                        <div class="surah-info">Surah Al-Fatiha | Verse 1 | Ruku 1</div>
                    </header>

                    <!-- Main Content -->
                    <main>
                        <!-- Arabic Text (clickable to cycle font size) -->
                        <h1 id="arabic" onclick="cycleFontSize()">
                            بِسْمِ ٱللَّهِ ٱلرَّحْمَٰنِ ٱلرَّحِيمِ
                        </h1>

                        <!-- Pronunciation and Audio Playback -->
                        <div class="pronunciation">
                            <span id="transliteration">Bismillāhir-Raḥmānir-Raḥīm</span>
                            <button onclick="playAudio()">▶️ Play Audio</button>
                        </div>

                        <!-- Loading indicator -->
                        <div id="loading" class="loading">Loading word-by-word data...</div>

                        <!-- Word-by-Word Translation Table -->
                        <table class="word-table">
                            <thead>
                                <tr>
                                    <th>Arabic</th>
                                    <th>Transliteration</th>
                                    <th>Translation</th>
                                </tr>
                            </thead>
                            <tbody id="word-table-body">
                                <!-- Populated dynamically -->
                            </tbody>
                        </table>

                        <!-- Tafsir Section (moved below the table) -->
                        <div class="tafsir">
                            <button onclick="toggleTafsir()">Show/Hide Tafsir</button>
                            <p id="tafsir-text" style="display: none">
                                This opening verse, the Basmalah, is a declaration of intent and
                                invocation that precedes every chapter of the Quran except Surah
                                At-Tawbah. 'Bismi' signifies starting with Allah's remembrance.
                                'Allāh' is His unique name. 'Ar-Raḥmān' reflects universal mercy and
                                'Ar-Raḥīm' denotes specific mercy for believers. Per Ibn Kathir,
                                it's a Sunnah before acts, symbolizing divine reliance.
                            </p>
                        </div>
                    </main>

                    <!-- Hidden Audio Element -->
                    <audio id="audioPlayer" preload="auto"></audio>

                    <!-- Navigation Bar -->
                    <footer class="nav-bar">
                        <button onclick="navigateSurah(-1)">&lt;&lt;&lt;</button>
                        <button onclick="navigateRuku(-1)">&lt;&lt;</button>
                        <button onclick="navigateVerse(-1)">&lt;</button>
                        <input type="text" id="search" value="1-1" onkeydown="if(event.key === 'Enter') navigateToVerse()" />
                        <button onclick="navigateVerse(1)">&gt;</button>
                        <button onclick="navigateRuku(1)">&gt;&gt;</button>
                        <button onclick="navigateSurah(1)">&gt;&gt;&gt;</button>
                    </footer>
                </div>

                <script>
        // Global variables
                    let currentAyah = {surah: 1, verse: 1 };
                    let surahNames = [];
                    let verseCounts = [];

                    // Load Surah metadata from API on startup
                    fetch("https://api.alquran.cloud/v1/meta")
            .then((response) => response.json())
            .then((data) => {
                        surahNames = data.data.surahs.references.map(
                            (ref) => ref.englishName
                        );
                    verseCounts = data.data.surahs.references.map(
                    (ref) => ref.numberOfAyahs
                    );
                    loadVerse(currentAyah.surah, currentAyah.verse);
            })
            .catch((err) => console.error("Error fetching metadata:", err));

                    // Load a specific verse (Arabic, transliteration, translation) and update the UI
                    function loadVerse(surah, verse) {
                        // Show loading indicator
                        document.getElementById("loading").style.display = "block";

                    // Update the search input and current ayah tracking
                    document.getElementById("search").value = `${surah}-${verse}`;
                    currentAyah = {surah, verse};

                    // Improved audio URL fetching
                    fetch(`https://api.alquran.cloud/v1/ayah/${surah}:${verse}/ar.alafasy`)
                .then((response) => response.json())
                .then((audioData) => {
                    const audioPlayer = document.getElementById("audioPlayer");
                    if (audioData.data && audioData.data.audio) {
                        currentAyah.audioUrl = audioData.data.audio;
                    audioPlayer.src = currentAyah.audioUrl;
                    } else {
                        console.warn(`No audio found for Surah ${surah}, Verse ${verse}`);
                    audioPlayer.src = ""; // Clear audio
                    }
                })
                .catch((err) => {
                        console.error("Error fetching audio URL:", err);
                    document.getElementById("audioPlayer").src = ""; // Clear audio
                });

                    // First, fetch the basic verse data (arabic, transliteration, translation)
                    Promise.all([
                    fetch(`https://api.alquran.cloud/v1/ayah/${surah}:${verse}/ar`),
                    fetch(
                    `https://api.alquran.cloud/v1/ayah/${surah}:${verse}/en.transliteration`
                    ),
                    fetch(`https://api.alquran.cloud/v1/ayah/${surah}:${verse}/en.sahih`),
                    ])
                .then((responses) => Promise.all(responses.map((res) => res.json())))
                .then(([arabicData, translitData, transData]) => {
                        // Update Arabic text
                        document.getElementById("arabic").innerText = arabicData.data.text;

                    // Update the transliteration text in the pronunciation section
                    document.getElementById("transliteration").innerText =
                    translitData.data.text;

                    // Update header information
                    document.querySelector(".surah-info").innerText = `Surah ${surahNames[surah - 1]
                    } | Verse ${verse}`;

                    // Now fetch the word-by-word data from Quran.com API
                    return fetch(
                    `https://api.quran.com/api/v4/verses/by_key/${surah}:${verse}?words=true&translations=131&word_fields=text_uthmani,transliteration&fields=text_uthmani`
                    )
                        .then((response) => response.json())
                        .catch((err) => {
                        console.error("Error fetching word-by-word data:", err);
                    // Return null to indicate we should use fallback
                    return null;
                        });
                })
                .then((wordData) => {
                    if (!wordData || !wordData.verse || !wordData.verse.words) {
                        // Use fallback method if we couldn't get word-by-word data
                        return fallbackWordByWord(surah, verse);
                    }

                    const words = wordData.verse.words;

                    // Update word-by-word table dynamically
                    const tbody = document.getElementById("word-table-body");
                    tbody.innerHTML = "";

                    words.forEach((word) => {
                        if (word.char_type_name !== "end") {
                            // Skip end-of-verse markers
                            const row = document.createElement("tr");

                    // Arabic word
                    const arabicCell = document.createElement("td");
                    arabicCell.textContent = word.text_uthmani;
                    arabicCell.dir = "rtl"; // Set direction to right-to-left
                    arabicCell.className = "arabic-word";
                    row.appendChild(arabicCell);

                    // Transliteration
                    const translitCell = document.createElement("td");
                    translitCell.textContent = word.transliteration?.text || "";
                    row.appendChild(translitCell);

                    // Translation
                    const transCell = document.createElement("td");
                    transCell.textContent = word.translation?.text || "";
                    row.appendChild(transCell);

                    tbody.appendChild(row);
                        }
                    });

                    // Hide loading indicator
                    document.getElementById("loading").style.display = "none";

                    // Also fetch and update the tafsir
                    return fetch(
                    `https://api.quran.com/api/v4/tafsirs/en-tafisr-ibn-kathir/by_ayah/${surah}:${verse}`
                    )
                        .then((response) => response.json())
                        .catch((err) => {
                        console.error("Error fetching tafsir:", err);
                    return {
                        tafsirs: [{text: "Tafsir not available for this verse." }],
                            };
                        });
                })
                .then((tafsirData) => {
                    if (
                    tafsirData &&
                    tafsirData.tafsirs &&
                        tafsirData.tafsirs.length > 0
                    ) {
                        document.getElementById("tafsir-text").innerHTML =
                        tafsirData.tafsirs[0].text;
                    } else {
                        document.getElementById("tafsir-text").innerHTML =
                        "Tafsir not available for this verse.";
                    }
                })
                .catch((err) => {
                        console.error("Error in verse loading process:", err);
                    // Fallback to basic word splitting as a last resort
                    fallbackWordByWord(surah, verse);
                });
        }

                    // Fallback function for word-by-word when API fails
                    function fallbackWordByWord(surah, verse) {
            return Promise.all([
                    fetch(`https://api.alquran.cloud/v1/ayah/${surah}:${verse}/ar`),
                    fetch(
                    `https://api.alquran.cloud/v1/ayah/${surah}:${verse}/en.transliteration`
                    ),
                    fetch(`https://api.alquran.cloud/v1/ayah/${surah}:${verse}/en.sahih`),
                    ])
                .then((responses) => Promise.all(responses.map((res) => res.json())))
                .then(([arabicData, translitData, transData]) => {
                        // Update Arabic text if not already updated
                        document.getElementById("arabic").innerText = arabicData.data.text;
                    document.getElementById("transliteration").innerText =
                    translitData.data.text;

                    // Split the text into words
                    const arabicWords = arabicData.data.text.split(/\s+/);
                    const translitWords = translitData.data.text.split(/\s+/);
                    const transWords = transData.data.text.split(/\s+/);

                    // Get the maximum length to ensure we have enough cells
                    const maxLength = Math.max(
                    arabicWords.length,
                    translitWords.length,
                    transWords.length
                    );

                    // Update the table
                    const tbody = document.getElementById("word-table-body");
                    tbody.innerHTML = "";

                    for (let i = 0; i < maxLength; i++) {
                        const row = document.createElement("tr");

                    // Arabic word
                    const arabicCell = document.createElement("td");
                    arabicCell.textContent = arabicWords[i] || "";
                    arabicCell.dir = "rtl"; // Set direction to right-to-left
                    arabicCell.className = "arabic-word";
                    row.appendChild(arabicCell);

                    // Transliteration
                    const translitCell = document.createElement("td");
                    translitCell.textContent = translitWords[i] || "";
                    row.appendChild(translitCell);

                    // Translation (this is approximate and may not match perfectly)
                    const transCell = document.createElement("td");
                    transCell.textContent = transWords[i] || "";
                    row.appendChild(transCell);

                    tbody.appendChild(row);
                    }

                    // Hide loading indicator
                    document.getElementById("loading").style.display = "none";

                    // Return null to indicate we have no tafsir data
                    return null;
                })
                .catch((err) => {
                        console.error("Error in fallback word-by-word:", err);
                    document.getElementById("loading").style.display = "none";
                    alert("Error loading verse data. Please try again later.");
                    return null;
                });
        }

                    // Font size cycling: Small, Medium, Large (in em units)
                    const fontSizes = [1.5, 2, 2.5];
                    let currentSizeIndex = 0;
                    function cycleFontSize() {
                        currentSizeIndex = (currentSizeIndex + 1) % fontSizes.length;
                    document.getElementById("arabic").style.fontSize =
                    fontSizes[currentSizeIndex] + "em";
        }

                    // Enhanced audio playback function with error handling
                    function playAudio() {
            const audioPlayer = document.getElementById("audioPlayer");

                    // Reset any previous error states
                    audioPlayer.onerror = null;

                    // Add error handling
                    audioPlayer.onerror = function (e) {
                        console.error("Audio playback error:", e);
                    alert(
                    `Unable to play audio for Surah ${currentAyah.surah}, Verse ${currentAyah.verse}`
                    );
            };

                    // Attempt to play audio
                    if (audioPlayer.src) {
                        audioPlayer.currentTime = 0;
                audioPlayer.play().catch((err) => {
                        console.error("Play method error:", err);
                    alert(`Audio playback failed: ${err.message}`);
                });
            } else {
                alert("No audio available for this verse.");
            }
        }

        // Toggle the display of the Tafsir text
        function toggleTafsir() {
            const tafsirText = document.getElementById("tafsir-text");
            tafsirText.style.display =
                tafsirText.style.display === "none" ? "block" : "none";
        }

        // Navigation: Previous/Next Verse
        function navigateVerse(direction) {
            let newVerse = currentAyah.verse + direction;
            let newSurah = currentAyah.surah;
            if (newVerse < 1) {
                newSurah--;
                if (newSurah < 1) return;
                newVerse = verseCounts[newSurah - 1];
            } else if (newVerse > verseCounts[currentAyah.surah - 1]) {
                newSurah++;
                if (newSurah > 114) return;
                newVerse = 1;
            }
            loadVerse(newSurah, newVerse);
        }

        // Navigation: Simulated Previous/Next Ruku (approx. 3 verses per Ruku)
        function navigateRuku(direction) {
            const offset = 3;
            let newVerse = currentAyah.verse + direction * offset;
            let newSurah = currentAyah.surah;
            if (newVerse < 1) {
                newSurah--;
                if (newSurah < 1) return;
                newVerse = verseCounts[newSurah - 1] + newVerse; // newVerse is negative here
            } else if (newVerse > verseCounts[currentAyah.surah - 1]) {
                newSurah++;
                if (newSurah > 114) return;
                newVerse = newVerse - verseCounts[currentAyah.surah - 1];
            }
            loadVerse(newSurah, newVerse);
        }

        // Navigation: Previous/Next Surah (loads first verse of that Surah)
        function navigateSurah(direction) {
            let newSurah = currentAyah.surah + direction;
            if (newSurah >= 1 && newSurah <= 114) {
                loadVerse(newSurah, 1);
            }
        }

        // Navigate based on search input (format: "surah-verse")
        function navigateToVerse() {
            const input = document.getElementById("search").value.split("-");
            const surah = parseInt(input[0]);
            const verse = parseInt(input[1]);
            if (
                surah >= 1 &&
                surah <= 114 &&
                verse >= 1 &&
                verse <= verseCounts[surah - 1]
            ) {
                loadVerse(surah, verse);
            } else {
                alert("Invalid Surah or Verse number");
            }
        }
    </script>
</body>

</html>